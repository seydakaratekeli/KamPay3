<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:res="clr-namespace:KamPay.Services"
             x:Class="KamPay.Views.ServiceRequestsPage"
             x:DataType="vm:ServiceRequestsViewModel"
             Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ServiceRequestsTitle]}"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:IsPendingConverter x:Key="IsPendingConverter" />
            <converters:IsAcceptedConverter x:Key="IsAcceptedConverter" />
            <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter" />
            <converters:IsNotZeroConverter x:Key="IsNotZeroConverter" />
            <converters:IsNegotiatingConverter x:Key="IsNegotiatingConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- ÃœST SEKMELER -->
        <Grid Grid.Row="0"
              ColumnDefinitions="*,*"
              Padding="15,10"
              ColumnSpacing="10"
              BackgroundColor="White">

            <!-- Gelen -->
            <Button Grid.Column="0"
                    Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[IncomingRequests]}"
                    Command="{Binding SelectIncomingCommand}"
                    HeightRequest="40"
                    CornerRadius="20"
                    FontSize="12"
                    FontAttributes="Bold"
                    BorderColor="{StaticResource Primary}"
                    BorderWidth="2">

                <Button.Triggers>
                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsIncomingSelected}"
                                 Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsIncomingSelected}"
                                 Value="False">
                        <Setter Property="BackgroundColor" Value="White" />
                        <Setter Property="TextColor" Value="{StaticResource Primary}" />
                    </DataTrigger>
                </Button.Triggers>

            </Button>

            <!-- Giden -->
            <Button Grid.Column="1"
                    Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[OutgoingRequests]}"
                    Command="{Binding SelectOutgoingCommand}"
                    HeightRequest="40"
                    CornerRadius="20"
                    FontSize="12"
                    FontAttributes="Bold"
                    BorderColor="{StaticResource Primary}"
                    BorderWidth="2">

                <Button.Triggers>
                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsOutgoingSelected}"
                                 Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsOutgoingSelected}"
                                 Value="False">
                        <Setter Property="BackgroundColor" Value="White" />
                        <Setter Property="TextColor" Value="{StaticResource Primary}" />
                    </DataTrigger>
                </Button.Triggers>

            </Button>

        </Grid>

        <!-- ANA Ä°Ã‡ERÄ°K -->
        <Grid Grid.Row="1">

            <!-- Refresh View -->
            <RefreshView Command="{Binding RefreshRequestsCommand}"
                         IsRefreshing="{Binding IsRefreshing}"
                         RefreshColor="{StaticResource Primary}"
                         IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">

                <Grid>

                    <!-- GELEN TALEPLER -->
                    <CollectionView ItemsSource="{Binding IncomingRequests}"
                                    IsVisible="{Binding IsIncomingSelected}"
                                    Margin="10">

                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="10"
                                                 Padding="30">
                                <Label Text="ðŸ“¥"
                                       FontSize="50"
                                       HorizontalTextAlignment="Center" />

                                <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[NoIncomingRequests]}"
                                       TextColor="{StaticResource Gray600}"
                                       FontSize="16"
                                       HorizontalTextAlignment="Center" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:ServiceRequest">

                                <Frame Margin="0,5"
                                       Padding="10"
                                       CornerRadius="15"
                                       BorderColor="{StaticResource Gray200}"
                                       HasShadow="True">

                                    <VerticalStackLayout Spacing="10">

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding ServiceTitle}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="{StaticResource Gray900}"
                                                   LineBreakMode="TailTruncation" />

                                            <Label Grid.Column="1"
                                                   Text="{Binding Status}"
                                                   FontAttributes="Bold"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Primary}" />
                                        </Grid>

                                        <Label Text="{Binding RequesterName, StringFormat='Talep Eden: {0}'}"
                                               TextColor="{StaticResource Gray600}" />

                                        <Label Text="{Binding Message}"
                                               TextColor="{StaticResource Gray900}"
                                               FontSize="13"
                                               MaxLines="2"
                                               LineBreakMode="TailTruncation"
                                               IsVisible="{Binding Message, Converter={StaticResource IsNotNullOrEmptyConverter}}" />

                                        <BoxView HeightRequest="1" 
                                                 Color="{StaticResource Gray200}" />

                                        <!-- ðŸ”¥ YENÄ°: PazarlÄ±k Bilgileri -->
                                        <VerticalStackLayout Spacing="5"
                                                             IsVisible="{Binding IsNegotiating, Converter={StaticResource IsNegotiatingConverter}}">
                                            <Label Text="ðŸ’° PazarlÄ±k Devam Ediyor"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Secondary}" />
                                            
                                            <Label Text="{Binding ProposedPriceByRequester, StringFormat='Talep Eden Teklifi: {0} â‚º'}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray600}"
                                                   IsVisible="{Binding ProposedPriceByRequester, Converter={StaticResource IsNotZeroConverter}}" />
                                            
                                            <Label Text="{Binding CounterOfferByProvider, StringFormat='Sizin KarÅŸÄ± Teklifiniz: {0} â‚º'}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray600}"
                                                   IsVisible="{Binding CounterOfferByProvider, Converter={StaticResource IsNotZeroConverter}}" />
                                        </VerticalStackLayout>

                                        <Grid ColumnDefinitions="Auto,*"
                                              ColumnSpacing="8">

                                            <Label Text="{Binding QuotedPrice, StringFormat='{0} â‚º'}"
                                                   TextColor="{StaticResource Primary}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding QuotedPrice, Converter={StaticResource IsNotZeroConverter}}" />

                                            <HorizontalStackLayout Grid.Column="1"
                                                                   HorizontalOptions="End"
                                                                   Spacing="8">

                                                <!-- ðŸ”¥ YENÄ°: Mesaj GÃ¶nder Butonu -->
                                                <Button Text="ðŸ’¬"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=StartConversationCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Secondary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        WidthRequest="40"
                                                        CornerRadius="5"
                                                        FontSize="14"
                                                        ToolTipProperties.Text="Mesaj GÃ¶nder" />

                                                <!-- ðŸ”¥ YENÄ°: KarÅŸÄ± Teklif Butonu (Pending durumunda) -->
                                                <Button Text="ðŸ’° Teklif"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=SendCounterOfferCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Secondary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="10"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}" />

                                                <!-- ðŸ”¥ YENÄ°: Fiyat Kabul Butonu (PazarlÄ±k devam ederken) -->
                                                <Button Text="âœ“ Kabul"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=AcceptNegotiatedPriceCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="10"
                                                        IsVisible="{Binding IsNegotiating, Converter={StaticResource IsNegotiatingConverter}}" />

                                                <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Reject]}"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=DeclineRequestCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Tertiary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="11"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}" />

                                                <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Accept]}"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=AcceptRequestCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Primary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="11"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}" />

                                            </HorizontalStackLayout>
                                        </Grid>

                                    </VerticalStackLayout>

                                </Frame>

                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                    <!-- GÄ°DEN TALEPLER -->
                    <CollectionView ItemsSource="{Binding OutgoingRequests}"
                                    IsVisible="{Binding IsOutgoingSelected}"
                                    Margin="10">

                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center"
                                                 HorizontalOptions="Center"
                                                 Spacing="10"
                                                 Padding="30">

                                <Label Text="ðŸ“¤"
                                       FontSize="50"
                                       HorizontalTextAlignment="Center" />

                                <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[NoOutgoingRequests]}"
                                       TextColor="{StaticResource Gray600}"
                                       FontSize="16"
                                       HorizontalTextAlignment="Center" />

                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:ServiceRequest">

                                <Frame Margin="0,5"
                                       Padding="10"
                                       CornerRadius="15"
                                       BorderColor="{StaticResource Gray200}"
                                       HasShadow="True"
                                       BackgroundColor="#FAFAFA">

                                    <VerticalStackLayout Spacing="10">

                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding ServiceTitle}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="{StaticResource Gray900}" />

                                            <Label Grid.Column="1"
                                                   Text="{Binding Status}"
                                                   FontAttributes="Bold"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Secondary}" />
                                        </Grid>

                                        <Label Text="{Binding Message}"
                                               TextColor="{StaticResource Gray900}"
                                               MaxLines="2"
                                               LineBreakMode="TailTruncation"
                                               IsVisible="{Binding Message, Converter={StaticResource IsNotNullOrEmptyConverter}}" />

                                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />

                                        <!-- ðŸ”¥ YENÄ°: PazarlÄ±k Bilgileri -->
                                        <VerticalStackLayout Spacing="5"
                                                             IsVisible="{Binding IsNegotiating, Converter={StaticResource IsNegotiatingConverter}}">
                                            <Label Text="ðŸ’° PazarlÄ±k Devam Ediyor"
                                                   FontSize="12"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Secondary}" />
                                            
                                            <Label Text="{Binding ProposedPriceByRequester, StringFormat='Sizin Teklifiniz: {0} â‚º'}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray600}"
                                                   IsVisible="{Binding ProposedPriceByRequester, Converter={StaticResource IsNotZeroConverter}}" />
                                            
                                            <Label Text="{Binding CounterOfferByProvider, StringFormat='KarÅŸÄ± Teklif: {0} â‚º'}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray600}"
                                                   IsVisible="{Binding CounterOfferByProvider, Converter={StaticResource IsNotZeroConverter}}" />
                                        </VerticalStackLayout>

                                        <Grid ColumnDefinitions="Auto,*"
                                              ColumnSpacing="8">

                                            <Label Text="{Binding QuotedPrice, StringFormat='{0} â‚º'}"
                                                   TextColor="{StaticResource Primary}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding QuotedPrice, Converter={StaticResource IsNotZeroConverter}}" />

                                            <HorizontalStackLayout Grid.Column="1"
                                                                   HorizontalOptions="End"
                                                                   Spacing="8">

                                                <!-- ðŸ”¥ YENÄ°: Mesaj GÃ¶nder Butonu -->
                                                <Button Text="ðŸ’¬"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=StartConversationCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Secondary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        WidthRequest="40"
                                                        CornerRadius="5"
                                                        FontSize="14"
                                                        ToolTipProperties.Text="Mesaj GÃ¶nder" />

                                                <!-- ðŸ”¥ YENÄ°: Fiyat Teklifi Butonu (Pending durumunda) -->
                                                <Button Text="ðŸ’° Teklif"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=ProposePriceCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Secondary}"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="10"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}" />

                                                <!-- ðŸ”¥ YENÄ°: Fiyat Kabul Butonu (PazarlÄ±k devam ederken) -->
                                                <Button Text="âœ“ Kabul"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=AcceptNegotiatedPriceCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="10"
                                                        IsVisible="{Binding IsNegotiating, Converter={StaticResource IsNegotiatingConverter}}" />

                                                <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[CompleteService]}"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceRequestsViewModel}}, Path=CompleteRequestCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#4CAF50"
                                                        TextColor="White"
                                                        HeightRequest="30"
                                                        CornerRadius="5"
                                                        FontSize="11"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsAcceptedConverter}}" />

                                            </HorizontalStackLayout>

                                        </Grid>

                                    </VerticalStackLayout>

                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                </Grid>
            </RefreshView>

            <!-- LOADING -->
            <Grid IsVisible="{Binding IsLoading}"
                  BackgroundColor="{StaticResource Gray100}">
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="15">

                    <ActivityIndicator IsRunning="True"
                                       Color="{StaticResource Primary}"
                                       WidthRequest="50"
                                       HeightRequest="50"/>

                    <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ServiceRequestsLoading]}"
                           TextColor="{StaticResource Gray600}"
                           FontSize="14"
                           HorizontalTextAlignment="Center"/>
                </VerticalStackLayout>
            </Grid>

        </Grid>
    </Grid>
</ContentPage>
