<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             xmlns:res="clr-namespace:KamPay.Services"
             x:Class="KamPay.Views.OffersPage"
             x:DataType="vm:OffersViewModel"
             Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[OffersTitle]}"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:IsAcceptedConverter x:Key="IsAcceptedConverter" />
            <converters:IsPendingConverter x:Key="IsPendingConverter" />
            <converters:ConfirmDonationButtonVisibilityConverter x:Key="ConfirmDonationButtonVisibilityConverter"/>
            <converters:SimulatePaymentButtonVisibilityConverter x:Key="SimulatePaymentButtonVisibilityConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- ÃœST SEKMELER -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" Padding="15,10" ColumnSpacing="10" BackgroundColor="White">

            <!-- Gelen Teklifler -->
            <Button Grid.Column="0"
                    Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[IncomingOffers]}"
                    Command="{Binding SelectIncomingCommand}"
                    HeightRequest="40"
                    CornerRadius="20"
                    FontSize="12"
                    FontAttributes="Bold"
                    BorderColor="{StaticResource Primary}"
                    BorderWidth="2">
                <Button.Triggers>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsIncomingSelected}"
                                 Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsIncomingSelected}"
                                 Value="False">
                        <Setter Property="BackgroundColor" Value="White" />
                        <Setter Property="TextColor" Value="{StaticResource Primary}" />
                    </DataTrigger>

                </Button.Triggers>
            </Button>

            <!-- Giden Teklifler -->
            <Button Grid.Column="1"
                    Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[OutgoingOffers]}"
                    Command="{Binding SelectOutgoingCommand}"
                    HeightRequest="40"
                    CornerRadius="20"
                    FontSize="12"
                    FontAttributes="Bold"
                    BorderColor="{StaticResource Primary}"
                    BorderWidth="2">
                <Button.Triggers>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsOutgoingSelected}"
                                 Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>

                    <DataTrigger TargetType="Button"
                                 Binding="{Binding IsOutgoingSelected}"
                                 Value="False">
                        <Setter Property="BackgroundColor" Value="White" />
                        <Setter Property="TextColor" Value="{StaticResource Primary}" />
                    </DataTrigger>

                </Button.Triggers>
            </Button>
        </Grid>

        <!-- ANA Ä°Ã‡ERÄ°K -->
        <Grid Grid.Row="1">

            <!-- RefreshView: YÃ¼kleme bitince gÃ¶rÃ¼nÃ¼r -->
            <RefreshView Command="{Binding RefreshOffersCommand}"
                         IsRefreshing="{Binding IsRefreshing}"
                         RefreshColor="{StaticResource Primary}"
                         IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">

                <Grid>

                    <!-- GELEN TEKLÄ°FLER -->
                    <CollectionView ItemsSource="{Binding IncomingOffers}"
                                    IsVisible="{Binding IsIncomingSelected}"
                                    Margin="10">

                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Padding="30">
                                <Label Text="ðŸ“¥" FontSize="50" HorizontalTextAlignment="Center"/>
                                <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[NoIncomingOffers]}"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center"
                                       FontSize="16"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Transaction">
                                <Frame Margin="0,5"
                                       Padding="10"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="15"
                                       HasShadow="True">

                                    <Grid ColumnDefinitions="80,*" ColumnSpacing="10">

                                        <!-- ÃœrÃ¼n Foto -->
                                        <ffimageloading:CachedImage Grid.Column="0"
                                                                    Source="{Binding ProductThumbnailUrl}"
                                                                    Aspect="AspectFill"
                                                                    HeightRequest="80"
                                                                    WidthRequest="80"
                                                                    LoadingPlaceholder="loading_image.png"
                                                                    ErrorPlaceholder="error_image.png">
                                            <ffimageloading:CachedImage.Clip>
                                                <RoundRectangleGeometry CornerRadius="10" Rect="0,0,80,80"/>
                                            </ffimageloading:CachedImage.Clip>
                                        </ffimageloading:CachedImage>

                                        <!-- SaÄŸ iÃ§erik -->
                                        <VerticalStackLayout Grid.Column="1" Spacing="5">

                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding ProductTitle}"
                                                       TextColor="{StaticResource Gray900}"
                                                       FontAttributes="Bold"
                                                       FontSize="15"
                                                       LineBreakMode="TailTruncation"/>

                                                <Label Grid.Column="1"
                                                       Text="{Binding StatusText}"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Primary}"
                                                       FontAttributes="Bold"/>
                                            </Grid>

                                            <Label Text="{Binding BuyerName, StringFormat='Talep Eden: {0}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Gray600}"/>

                                            <Label Text="{Binding Message}"
                                                   FontSize="13"
                                                   MaxLines="2"
                                                   LineBreakMode="TailTruncation"
                                                   TextColor="{StaticResource Gray900}"/>

                                            <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5"/>

                                            <!-- Butonlar -->
                                            <Grid ColumnDefinitions="Auto,*">

                                                <Label Text="{Binding Price, StringFormat='{0} â‚º'}"
                                                       TextColor="{StaticResource Primary}"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>

                                                <HorizontalStackLayout Grid.Column="1"
                                                                       HorizontalOptions="End"
                                                                       Spacing="8">

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Reject]}"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=RejectOfferCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="{StaticResource Tertiary}"
                                                            TextColor="White"
                                                            HeightRequest="30"
                                                            CornerRadius="5"
                                                            FontSize="11"
                                                            IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}"/>

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Accept]}"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=AcceptOfferCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="{StaticResource Primary}"
                                                            TextColor="White"
                                                            HeightRequest="30"
                                                            CornerRadius="5"
                                                            FontSize="11"
                                                            IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}"/>

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[DeliveryQR]}"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=ManageDeliveryCommand}"
                                                            CommandParameter="{Binding .}"
                                                            BackgroundColor="{StaticResource Secondary}"
                                                            TextColor="White"
                                                            HeightRequest="30"
                                                            CornerRadius="5"
                                                            FontSize="11"
                                                            IsVisible="{Binding CanManageDelivery}"/>

                                                </HorizontalStackLayout>
                                            </Grid>

                                        </VerticalStackLayout>
                                    </Grid>

                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                    <!-- GÄ°DEN TEKLÄ°FLER -->
                    <CollectionView ItemsSource="{Binding OutgoingOffers}"
                                    IsVisible="{Binding IsOutgoingSelected}"
                                    Margin="10">

                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Padding="30">
                                <Label Text="ðŸ“¤" FontSize="50" HorizontalTextAlignment="Center"/>
                                <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[NoOutgoingOffers]}"
                                       TextColor="{StaticResource Gray600}"
                                       HorizontalTextAlignment="Center"
                                       FontSize="16"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Transaction">
                                <Frame Margin="0,5"
                                       Padding="10"
                                       BorderColor="{StaticResource Gray200}"
                                       CornerRadius="15"
                                       HasShadow="True"
                                       BackgroundColor="#FAFAFA">

                                    <Grid ColumnDefinitions="80,*" ColumnSpacing="10">

                                        <ffimageloading:CachedImage Grid.Column="0"
                                                                    Source="{Binding ProductThumbnailUrl}"
                                                                    Aspect="AspectFill"
                                                                    HeightRequest="80"
                                                                    WidthRequest="80"
                                                                    LoadingPlaceholder="loading_image.png"
                                                                    ErrorPlaceholder="error_image.png">
                                            <ffimageloading:CachedImage.Clip>
                                                <RoundRectangleGeometry CornerRadius="10" Rect="0,0,80,80"/>
                                            </ffimageloading:CachedImage.Clip>
                                        </ffimageloading:CachedImage>

                                        <VerticalStackLayout Grid.Column="1" Spacing="5">

                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Grid.Column="0"
                                                       Text="{Binding ProductTitle}"
                                                       FontAttributes="Bold"
                                                       FontSize="15"
                                                       TextColor="{StaticResource Gray900}"
                                                       LineBreakMode="TailTruncation" />

                                                <Label Grid.Column="1"
                                                       Text="{Binding StatusText}"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Secondary}"
                                                       FontAttributes="Bold"/>
                                            </Grid>

                                            <Label Text="{Binding SellerName, StringFormat='SatÄ±cÄ±: {0}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Gray600}"/>

                                            <Label Text="{Binding Message}"
                                                   FontSize="13"
                                                   MaxLines="2"
                                                   LineBreakMode="TailTruncation"
                                                   TextColor="{StaticResource Gray900}"/>

                                            <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5"/>

                                            <Grid ColumnDefinitions="Auto,*">

                                                <Label Text="{Binding Price, StringFormat='{0} â‚º'}"
                                                     TextColor="{StaticResource Primary}"
                                                     FontAttributes="Bold"
                                                     VerticalOptions="Center"/>

                                                <HorizontalStackLayout Grid.Column="1"
                                                                     HorizontalOptions="End"
                                                                     Spacing="8">

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[MakePayment]}"
                                                          Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=CompletePaymentCommand}"
                                                          CommandParameter="{Binding .}"
                                                          BackgroundColor="{StaticResource Primary}"
                                                          TextColor="White"
                                                          HeightRequest="30"
                                                          CornerRadius="5"
                                                          FontSize="11"
                                                          IsVisible="{Binding Path=., Converter={StaticResource SimulatePaymentButtonVisibilityConverter}}" />

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ConfirmReceived]}"
                                                          Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=ConfirmDonationReceivedCommand}"
                                                          CommandParameter="{Binding .}"
                                                          BackgroundColor="#4CAF50"
                                                          TextColor="White"
                                                          HeightRequest="30"
                                                          CornerRadius="5"
                                                          FontSize="11"
                                                          IsVisible="{Binding Path=., Converter={StaticResource ConfirmDonationButtonVisibilityConverter}}" />

                                                    <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[DeliveryQR]}"
                                                          Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=ManageDeliveryCommand}"
                                                          CommandParameter="{Binding .}"
                                                          BackgroundColor="{StaticResource Secondary}"
                                                          TextColor="White"
                                                          HeightRequest="30"
                                                          CornerRadius="5"
                                                          FontSize="11"
                                                          IsVisible="{Binding CanManageDelivery}" />

                                                </HorizontalStackLayout>
                                            </Grid>

                                        </VerticalStackLayout>
                                    </Grid>

                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>

                    </CollectionView>

                </Grid>
            </RefreshView>

            <!-- LOADING -->
            <Grid IsVisible="{Binding IsLoading}"
                  BackgroundColor="{StaticResource Gray100}">

                <VerticalStackLayout VerticalOptions="Center"
                                      HorizontalOptions="Center"
                                      Spacing="15">

                    <ActivityIndicator IsRunning="True"
                                       Color="{StaticResource Primary}"
                                       WidthRequest="50"
                                       HeightRequest="50"/>

                    <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[OffersLoading]}"
                           TextColor="{StaticResource Gray600}"
                           FontSize="14"
                           HorizontalTextAlignment="Center"/>
                </VerticalStackLayout>

            </Grid>

        </Grid>
    </Grid>
</ContentPage>
