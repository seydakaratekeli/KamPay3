<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             x:Class="KamPay.Views.OffersPage"
             x:DataType="vm:OffersViewModel"
             Title="Teklifler"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:IsAcceptedConverter x:Key="IsAcceptedConverter" />
            <converters:IsPendingConverter x:Key="IsPendingConverter" />
            <converters:ConfirmDonationButtonVisibilityConverter x:Key="ConfirmDonationButtonVisibilityConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *">

        <Grid Grid.Row="0" ColumnDefinitions="*,*" Padding="15,10" ColumnSpacing="10" BackgroundColor="White">
            <Button Grid.Column="0" Text="Gelen Teklifler" Command="{Binding SelectIncomingCommand}" BackgroundColor="{Binding IsIncomingSelected, Converter={StaticResource InvertedBoolConverter}, ConverterParameter={StaticResource Primary}}" TextColor="{Binding IsIncomingSelected, Converter={StaticResource InvertedBoolConverter}, ConverterParameter=White}" BorderColor="{StaticResource Primary}" BorderWidth="1" HeightRequest="40" CornerRadius="20" FontSize="12" FontAttributes="Bold">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding IsIncomingSelected}" Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                        <Setter Property="TextColor" Value="White"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding IsIncomingSelected}" Value="False">
                        <Setter Property="BackgroundColor" Value="White"/>
                        <Setter Property="TextColor" Value="{StaticResource Primary}"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>

            <Button Grid.Column="1" Text="Giden Teklifler" Command="{Binding SelectOutgoingCommand}" HeightRequest="40" CornerRadius="20" FontSize="12" FontAttributes="Bold" BorderColor="{StaticResource Primary}" BorderWidth="1">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding IsOutgoingSelected}" Value="True">
                        <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                        <Setter Property="TextColor" Value="White"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding IsOutgoingSelected}" Value="False">
                        <Setter Property="BackgroundColor" Value="White"/>
                        <Setter Property="TextColor" Value="{StaticResource Primary}"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
        </Grid>

        <RefreshView Grid.Row="1" Command="{Binding RefreshOffersCommand}" IsRefreshing="{Binding IsRefreshing}" RefreshColor="{StaticResource Primary}">
            <Grid IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">

                <CollectionView ItemsSource="{Binding IncomingOffers}" IsVisible="{Binding IsIncomingSelected}" Margin="10">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Padding="30">
                            <Label Text="ðŸ“¥" FontSize="50" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding EmptyMessage}" TextColor="{StaticResource Gray600}" HorizontalTextAlignment="Center" FontSize="16"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Transaction">
                            <Frame Margin="0,5" Padding="10" BorderColor="{StaticResource Gray200}" CornerRadius="15" HasShadow="True">
                                <Grid ColumnDefinitions="80, *" ColumnSpacing="10">
                                    <ffimageloading:CachedImage Grid.Column="0" Source="{Binding ProductThumbnailUrl}" Aspect="AspectFill" HeightRequest="80" WidthRequest="80" LoadingPlaceholder="loading_image.png" ErrorPlaceholder="error_image.png">
                                        <ffimageloading:CachedImage.Clip>
                                            <RoundRectangleGeometry CornerRadius="10" Rect="0,0,80,80"/>
                                        </ffimageloading:CachedImage.Clip>
                                    </ffimageloading:CachedImage>

                                    <VerticalStackLayout Grid.Column="1" Spacing="5">
                                        <Grid ColumnDefinitions="*, Auto">
                                            <Label Grid.Column="0" Text="{Binding ProductTitle}" FontAttributes="Bold" FontSize="15" LineBreakMode="TailTruncation" TextColor="{StaticResource Gray900}"/>
                                            <Label Grid.Column="1" Text="{Binding StatusText}" FontSize="11" TextColor="{StaticResource Primary}" FontAttributes="Bold"/>
                                        </Grid>

                                        <Label Text="{Binding BuyerName, StringFormat='Talep Eden: {0}'}" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                        <Label Text="{Binding Message}" TextColor="{StaticResource Gray900}" FontSize="13" LineBreakMode="TailTruncation" MaxLines="2"/>

                                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5"/>

                                        <Grid ColumnDefinitions="Auto, *" VerticalOptions="End">
                                            <Label Text="{Binding Price, StringFormat='{0} â‚º'}" TextColor="{StaticResource Primary}" FontAttributes="Bold" VerticalOptions="Center"/>

                                            <HorizontalStackLayout Grid.Column="1" HorizontalOptions="End" Spacing="8">
                                                <Button Text="Reddet" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=RejectOfferCommand}" CommandParameter="{Binding .}" BackgroundColor="{StaticResource Danger}" TextColor="White" HeightRequest="30" Padding="10,0" FontSize="11" CornerRadius="5" IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}"/>
                                                <Button Text="Kabul Et" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=AcceptOfferCommand}" CommandParameter="{Binding .}" BackgroundColor="{StaticResource Primary}" TextColor="White" HeightRequest="30" Padding="10,0" FontSize="11" CornerRadius="5" IsVisible="{Binding Status, Converter={StaticResource IsPendingConverter}}"/>

                                                <Button Text="Teslimat QR" Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=ManageDeliveryCommand}" CommandParameter="{Binding .}" BackgroundColor="{StaticResource Secondary}" TextColor="White" HeightRequest="30" Padding="10,0" FontSize="11" CornerRadius="5" IsVisible="{Binding CanManageDelivery}"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <CollectionView ItemsSource="{Binding OutgoingOffers}" IsVisible="{Binding IsOutgoingSelected}" Margin="10">
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Padding="30">
                            <Label Text="ðŸ“¤" FontSize="50" HorizontalTextAlignment="Center"/>
                            <Label Text="{Binding EmptyMessage}" TextColor="{StaticResource Gray600}" HorizontalTextAlignment="Center" FontSize="16"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Transaction">
                            <Frame Margin="0,5" Padding="10" BorderColor="{StaticResource Gray200}" CornerRadius="15" HasShadow="True" BackgroundColor="#FAFAFA">
                                <Grid ColumnDefinitions="80, *" ColumnSpacing="10">
                                    <ffimageloading:CachedImage Grid.Column="0" Source="{Binding ProductThumbnailUrl}" Aspect="AspectFill" HeightRequest="80" WidthRequest="80" LoadingPlaceholder="loading_image.png" ErrorPlaceholder="error_image.png">
                                        <ffimageloading:CachedImage.Clip>
                                            <RoundRectangleGeometry CornerRadius="10" Rect="0,0,80,80"/>
                                        </ffimageloading:CachedImage.Clip>
                                    </ffimageloading:CachedImage>

                                    <VerticalStackLayout Grid.Column="1" Spacing="5">
                                        <Grid ColumnDefinitions="*, Auto">
                                            <Label Grid.Column="0" Text="{Binding ProductTitle}" FontAttributes="Bold" FontSize="15" LineBreakMode="TailTruncation" TextColor="{StaticResource Gray900}"/>
                                            <Label Grid.Column="1" Text="{Binding StatusText}" FontSize="11" TextColor="{StaticResource Secondary}" FontAttributes="Bold"/>
                                        </Grid>

                                        <Label Text="{Binding SellerName, StringFormat='SatÄ±cÄ±: {0}'}" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                        <Label Text="{Binding Message}" TextColor="{StaticResource Gray900}" FontSize="13" LineBreakMode="TailTruncation" MaxLines="2"/>

                                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,5"/>

                                        <Grid ColumnDefinitions="Auto, *" VerticalOptions="End">
                                            <Label Text="{Binding Price, StringFormat='{0} â‚º'}" TextColor="{StaticResource Primary}" FontAttributes="Bold" VerticalOptions="Center"/>

                                            <HorizontalStackLayout Grid.Column="1" HorizontalOptions="End" Spacing="8">
                                                <Button Text="Ã–deme Yap" 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=CompletePaymentAsync}" 
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{StaticResource Primary}" TextColor="White" HeightRequest="30" Padding="10,0" FontSize="11" CornerRadius="5"
                                                        IsVisible="{Binding Status, Converter={StaticResource IsAcceptedConverter}}"/>

                                                <Button Text="Teslim AldÄ±m" 
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OffersViewModel}}, Path=ConfirmDonationReceivedCommand}" 
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="#4CAF50" TextColor="White" HeightRequest="30" Padding="10,0" FontSize="11" CornerRadius="5"
                                                        IsVisible="{Binding Path=., Converter={StaticResource ConfirmDonationButtonVisibilityConverter}}"/>
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </RefreshView>

        <ActivityIndicator Grid.Row="1" IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" Color="{StaticResource Primary}" VerticalOptions="Center" HorizontalOptions="Center" HeightRequest="50" WidthRequest="50"/>
    </Grid>
</ContentPage>