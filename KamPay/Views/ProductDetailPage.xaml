<?xml version="1.0" encoding="utf-8" ?>
<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:KamPay.ViewModels"
    xmlns:models="clr-namespace:KamPay.Models"
    xmlns:converters="clr-namespace:KamPay.Converters"
    xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
    xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
    x:Class="KamPay.Views.ProductDetailPage"
    Title="ÃœrÃ¼n DetayÄ±"
    BackgroundColor="#F5F5F5"
    Shell.BackgroundColor="#4CAF50"
    Shell.ForegroundColor="White">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colors -->
            <Color x:Key="Primary">#4CAF50</Color>
            <Color x:Key="PrimaryDark">#388E3C</Color>
            <Color x:Key="TextPrimary">#212121</Color>
            <Color x:Key="TextSecondary">#757575</Color>
            <Color x:Key="Surface">#FFFFFF</Color>
            <Color x:Key="BorderColor">#EEEEEE</Color>
            <Color x:Key="Danger">#D32F2F</Color>

            <!-- Converters -->
            <converters:InvertedBoolConverter x:Key="InverseBoolConverter" />
            <converters:IsNotNullOrEmptyConverter x:Key="StringIsNotNullOrEmptyConverter" />
            <converters:ProductTypeToBadgeColorConverter x:Key="ProductTypeToBadgeColorConverter" />
            <converters:ProductCategoryToTextConverter x:Key="ProductCategoryToTextConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">

        <!-- SCROLLABLE CONTENT -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="0">

                <!-- HEADER IMAGE & CAROUSEL -->
                <Grid HeightRequest="350">
                    <CarouselView ItemsSource="{Binding ProductImages}"
                                  Position="{Binding CurrentImageIndex}"
                                  IndicatorView="indicatorView"
                                  Loop="False">
                        <CarouselView.ItemTemplate>
                            <DataTemplate>
                                <Image Source="{Binding .}" Aspect="AspectFill" />
                            </DataTemplate>
                        </CarouselView.ItemTemplate>
                    </CarouselView>

                    <!-- Gradient Overlay for Indicators (Grid kullanÄ±mÄ± BoxView'den daha gÃ¼venlidir) -->
                    <Grid VerticalOptions="End" HeightRequest="80">
                        <Grid.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="Transparent" Offset="0.0" />
                                <GradientStop Color="#99000000" Offset="1.0" />
                            </LinearGradientBrush>
                        </Grid.Background>
                    </Grid>

                    <IndicatorView x:Name="indicatorView"
                                   IndicatorColor="#E0E0E0"
                                   SelectedIndicatorColor="{StaticResource Primary}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="End"
                                   Margin="0,0,0,45" />
                </Grid>

                <!-- MAIN CONTENT SHEET -->
                <Border StrokeThickness="0"
                        BackgroundColor="{StaticResource Surface}"
                        StrokeShape="RoundRectangle 24,24,0,0"
                        Margin="0,-30,0,0"
                        Padding="24,30,24,40">
                    <Border.Shadow>
                        <Shadow Brush="Black" Offset="0,-4" Radius="10" Opacity="0.1" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="20">

                        <!-- Title, Badge & Price Section -->
                        <VerticalStackLayout Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="{Binding Product.CreatedAt, StringFormat='{0:d MMMM yyyy}'}"
                                       TextColor="{StaticResource TextSecondary}"
                                       FontSize="12"
                                       VerticalOptions="Center"/>

                                <Border BackgroundColor="{Binding Product.Type, Converter={StaticResource ProductTypeToBadgeColorConverter}}"
                                        StrokeShape="RoundRectangle 8"
                                        StrokeThickness="0"
                                        Padding="10,5"
                                        HorizontalOptions="End">
                                    <Label Text="{Binding Product.TypeText}"
                                           TextColor="White"
                                           FontSize="11"
                                           FontAttributes="Bold"
                                           TextTransform="Uppercase"/>
                                </Border>
                            </Grid>

                            <Label Text="{Binding Product.Title}"
                                   TextColor="{StaticResource TextPrimary}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   LineBreakMode="WordWrap" />

                            <Label Text="{Binding Product.PriceText}"
                                   TextColor="{StaticResource Primary}"
                                   FontSize="28"
                                   FontAttributes="Bold"
                                   Margin="0,-4,0,0"/>
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1" Color="{StaticResource BorderColor}" />

                        <!-- Details Grid (Condition, Category) -->
                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" RowSpacing="15" ColumnSpacing="15">
                            <!-- Condition -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                <Label Text="Durum" TextColor="{StaticResource TextSecondary}" FontSize="12" />
                                <!-- SemiBold yerine Bold kullanÄ±ldÄ± -->
                                <Label Text="{Binding Product.ConditionText}" TextColor="{StaticResource TextPrimary}" FontSize="15" FontAttributes="Bold" />
                            </VerticalStackLayout>

                            <!-- Category -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                <Label Text="Kategori" TextColor="{StaticResource TextSecondary}" FontSize="12" />
                                <!-- SemiBold yerine Bold kullanÄ±ldÄ± -->
                                <Label Text="{Binding Product.CategoryName, Converter={StaticResource ProductCategoryToTextConverter}}" TextColor="{StaticResource TextPrimary}" FontSize="15" FontAttributes="Bold" />
                            </VerticalStackLayout>

                            <!-- Exchange Preference -->
                            <VerticalStackLayout Grid.Row="1" Grid.ColumnSpan="2" Spacing="4"
                                                  IsVisible="{Binding Product.ExchangePreference, Converter={StaticResource StringIsNotNullOrEmptyConverter}}">
                                <Label Text="Takas Tercihi" TextColor="{StaticResource TextSecondary}" FontSize="12" />
                                <Frame Padding="12" BackgroundColor="#E3F2FD" BorderColor="#BBDEFB" CornerRadius="8" HasShadow="False">
                                    <Label Text="{Binding Product.ExchangePreference}" TextColor="#1565C0" FontSize="14" />
                                </Frame>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Description -->
                        <VerticalStackLayout Spacing="8" Margin="0,10,0,0">
                            <Label Text="AÃ§Ä±klama" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Label Text="{Binding Product.Description}" 
                                   FontSize="15" 
                                   TextColor="#424242" 
                                   LineHeight="1.4" />
                        </VerticalStackLayout>

                        <!-- Map Section -->
                        <VerticalStackLayout Spacing="12" IsVisible="{Binding HasLocation}" Margin="0,10,0,0">
                            <Label Text="Konum" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                            <Border StrokeShape="RoundRectangle 16"
                                    HeightRequest="220"
                                    StrokeThickness="1"
                                    Stroke="{StaticResource BorderColor}"
                                    BackgroundColor="#F0F0F0">
                                <Grid>
                                    <mapsui:MapControl x:Name="ProductMap" VerticalOptions="Fill" HorizontalOptions="Fill" />

                                    <!-- Map Controls -->
                                    <VerticalStackLayout HorizontalOptions="End" VerticalOptions="Start" Margin="10" Spacing="8">
                                        <Button Text="+" Clicked="OnZoomInClicked" WidthRequest="36" HeightRequest="36" CornerRadius="18" BackgroundColor="White" TextColor="Black" Padding="0" FontSize="20" Shadow="{Shadow Brush=Black, Opacity=0.2, Radius=4}" />
                                        <Button Text="âˆ’" Clicked="OnZoomOutClicked" WidthRequest="36" HeightRequest="36" CornerRadius="18" BackgroundColor="White" TextColor="Black" Padding="0" FontSize="20" Shadow="{Shadow Brush=Black, Opacity=0.2, Radius=4}" />
                                        <Button Text="ðŸŽ¯" Clicked="OnResetLocationClicked" WidthRequest="36" HeightRequest="36" CornerRadius="18" BackgroundColor="White" TextColor="{StaticResource Primary}" Padding="0" FontSize="16" Margin="0,8,0,0" Shadow="{Shadow Brush=Black, Opacity=0.2, Radius=4}" />
                                    </VerticalStackLayout>

                                    <!-- Address Strip -->
                                    <Border VerticalOptions="End" Margin="10" BackgroundColor="White" StrokeShape="RoundRectangle 10" Padding="12" Shadow="{Shadow Brush=Black, Opacity=0.15, Radius=5}">
                                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                            <Label Text="ðŸ“" VerticalOptions="Center"/>
                                            <Label Grid.Column="1" Text="{Binding Product.Location}" FontSize="13" TextColor="{StaticResource TextPrimary}" LineBreakMode="TailTruncation" MaxLines="2" VerticalOptions="Center"/>
                                            <Button Grid.Column="2" Text="Git" Command="{Binding OpenLocationCommand}" HeightRequest="32" CornerRadius="16" Padding="15,0" BackgroundColor="{StaticResource Primary}" TextColor="White" FontSize="12" FontAttributes="Bold"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Seller Info Card -->
                        <Border StrokeShape="RoundRectangle 16"
                                StrokeThickness="1"
                                Stroke="{StaticResource BorderColor}"
                                BackgroundColor="White"
                                Padding="12"
                                Margin="0,10,0,0">
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <ffimageloading:CachedImage Grid.Column="0"
                                                            Source="{Binding Product.UserPhotoUrl}"
                                                            WidthRequest="50" HeightRequest="50"
                                                            Aspect="AspectFill"
                                                            LoadingPlaceholder="person_icon.svg"
                                                            ErrorPlaceholder="person_icon.svg">
                                    <ffimageloading:CachedImage.Clip>
                                        <EllipseGeometry Center="25,25" RadiusX="25" RadiusY="25" />
                                    </ffimageloading:CachedImage.Clip>
                                </ffimageloading:CachedImage>

                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                    <Label Text="{Binding Product.UserName}" FontSize="16" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                    <Label Text="{Binding Product.TimeAgoText}" FontSize="12" TextColor="{StaticResource TextSecondary}"/>
                                </VerticalStackLayout>

                                <Button Grid.Column="2" 
                                        Text="SatÄ±cÄ± Profili" 
                                        TextColor="{StaticResource Primary}" 
                                        BackgroundColor="Transparent" 
                                        FontSize="13" 
                                        FontAttributes="Bold"
                                        Padding="0"
                                        HeightRequest="40"/>
                            </Grid>
                        </Border>

                        <!-- View Stats -->
                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="6" Opacity="0.6" Margin="0,10,0,20">
                            <Label Text="ðŸ‘" FontSize="14" VerticalOptions="Center"/>
                            <Label Text="{Binding Product.ViewCount, StringFormat='{0} kez gÃ¶rÃ¼ntÃ¼lendi'}" FontSize="12" VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>

        <!-- STICKY BOTTOM ACTION BAR -->
        <Border Grid.Row="1" 
                VerticalOptions="End" 
                BackgroundColor="{StaticResource Surface}" 
                StrokeThickness="0" 
                Padding="16,16,16,24" 
                Shadow="{Shadow Brush=Black, Opacity=0.15, Radius=10, Offset='0,-4'}">
            <Grid>
                <!-- Owner Actions -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12" IsVisible="{Binding IsOwner}">
                    <!-- SemiBold yerine Bold kullanÄ±ldÄ± -->
                    <Button Grid.Column="0" Text="DÃ¼zenle" Command="{Binding EditProductCommand}" BackgroundColor="#F5F5F5" TextColor="{StaticResource TextPrimary}" CornerRadius="12" FontAttributes="Bold" HeightRequest="50"/>
                    <Button Grid.Column="1" Text="SatÄ±ldÄ±" Command="{Binding MarkAsSoldCommand}" IsVisible="{Binding Product.IsSold, Converter={StaticResource InverseBoolConverter}}" BackgroundColor="{StaticResource Primary}" TextColor="White" CornerRadius="12" FontAttributes="Bold" HeightRequest="50"/>
                    <Button Grid.Column="2" Text="Sil" Command="{Binding DeleteProductCommand}" BackgroundColor="#FFEBEE" TextColor="{StaticResource Danger}" CornerRadius="12" FontAttributes="Bold" HeightRequest="50"/>
                </Grid>

                <!-- Buyer Actions -->
                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12" IsVisible="{Binding CanContact}">

                    <!-- Favorite Button -->
                    <Button Grid.Column="0" Command="{Binding ToggleFavoriteCommand}" WidthRequest="50" HeightRequest="50" CornerRadius="14" BackgroundColor="#FFF8E1" BorderColor="Transparent">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding IsFavorite}" Value="True">
                                <Setter Property="Text" Value="â¤ï¸"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Button" Binding="{Binding IsFavorite}" Value="False">
                                <Setter Property="Text" Value="ðŸ¤"/>
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                    <!-- Main Action Button (Buy/Request/Offer) -->
                    <!-- SemiBold yerine Bold kullanÄ±ldÄ± -->
                    <Button Grid.Column="1" Command="{Binding SendRequestCommand}" HeightRequest="50" CornerRadius="14" BackgroundColor="{StaticResource Primary}" TextColor="White" FontAttributes="Bold" FontSize="15" Shadow="{Shadow Brush={StaticResource Primary}, Opacity=0.4, Radius=8, Offset='0,4'}">
                        <Button.Triggers>
                            <DataTrigger TargetType="Button" Binding="{Binding Product.Type}" Value="{x:Static models:ProductType.Satis}">
                                <Setter Property="Text" Value="SatÄ±n Almak Ä°ste" />
                            </DataTrigger>
                            <DataTrigger TargetType="Button" Binding="{Binding Product.Type}" Value="{x:Static models:ProductType.Bagis}">
                                <Setter Property="Text" Value="Almak Ä°stiyorum" />
                            </DataTrigger>
                            <DataTrigger TargetType="Button" Binding="{Binding Product.Type}" Value="{x:Static models:ProductType.Takas}">
                                <Setter Property="Text" Value="Takas Teklif Et" />
                            </DataTrigger>
                        </Button.Triggers>
                    </Button>

                    <!-- Message Button -->
                    <Button Grid.Column="2" Text="ðŸ’¬" Command="{Binding ContactSellerCommand}" WidthRequest="50" HeightRequest="50" CornerRadius="14" BackgroundColor="#E3F2FD" TextColor="#1976D2" FontSize="20"/>
                </Grid>

                <!-- Report Button -->
                <Button Grid.Column="2"
                        Text="ðŸš©"
                        Command="{Binding ReportProductCommand}" 
                        IsVisible="{Binding IsOwner, Converter={StaticResource InverseBoolConverter}}"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Danger}"
                        FontSize="18"
                        WidthRequest="40"
                        HeightRequest="40"
                        Margin="0,-330,20,0"
                        InputTransparent="False"
                        ZIndex="10"/>
            </Grid>
        </Border>

        <!-- LOADING OVERLAY -->
        <Grid Grid.RowSpan="2" IsVisible="{Binding IsLoading}" BackgroundColor="#80000000" InputTransparent="False">
            <ActivityIndicator IsRunning="True" Color="White" WidthRequest="50" HeightRequest="50"
                               VerticalOptions="Center" HorizontalOptions="Center" />
        </Grid>
    </Grid>
</ContentPage>