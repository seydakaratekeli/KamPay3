<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:conv="clr-namespace:KamPay.Converters"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:res="clr-namespace:KamPay.Services"
             x:Class="KamPay.Views.EditProductPage"
             Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[EditProduct]}"
             Shell.BackgroundColor="{StaticResource Primary}">



    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">

            <!-- Hata MesajÄ± -->
            <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"
                   BackgroundColor="#FFEBEE"
                   BorderColor="#F44336"
                   Padding="10"
                   CornerRadius="8">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#C62828"
                       FontSize="14" />
            </Frame>

            <!-- BaÅŸlÄ±k -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductInfo]}" 
                   FontSize="20" 
                   FontAttributes="Bold"
                   TextColor="#333" />

            <!-- ÃœrÃ¼n BaÅŸlÄ±ÄŸÄ± -->
            <Frame Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Entry Placeholder="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductTitle]}"
                       Text="{Binding Title}"
                       MaxLength="100"
                       FontSize="16" />
            </Frame>

            <!-- AÃ§Ä±klama -->
            <Frame Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Editor Placeholder="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductDescription]}"
                        Text="{Binding Description}"
                        HeightRequest="120"
                        MaxLength="1000"
                        FontSize="16"
                        AutoSize="TextChanges" />
            </Frame>

            <!-- Kategori SeÃ§imi -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Category]}" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="#666" />

            <Frame Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Picker ItemsSource="{Binding Categories}"
                        SelectedItem="{Binding SelectedCategory}"
                        ItemDisplayBinding="{Binding Name}"
                        FontSize="16"
                        Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[SelectCategory]}" />
            </Frame>

            <!-- ÃœrÃ¼n Tipi -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductType]}" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="#666" />

            <Frame Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Picker ItemsSource="{Binding ProductTypes}"
                        SelectedItem="{Binding SelectedType}"
                        FontSize="16"
                        Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[SelectType]}">
                    <Picker.ItemDisplayBinding>
                        <Binding>
                            <Binding.Converter>
                                <conv:ProductTypeConverter />
                            </Binding.Converter>
                        </Binding>
                    </Picker.ItemDisplayBinding>
                </Picker>
            </Frame>

            <!-- Fiyat (SatÄ±lÄ±k ise) -->
            <Frame IsVisible="{Binding ShowPriceField}"
                   Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <HorizontalStackLayout Padding="10">
                    <Entry Placeholder="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Price]}"
                           Text="{Binding Price}"
                           Keyboard="Numeric"
                           FontSize="16"
                           HorizontalOptions="FillAndExpand" />
                    <Label Text="â‚º" 
                           VerticalOptions="Center"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="#4CAF50" />
                </HorizontalStackLayout>
            </Frame>

            <!-- Takas Tercihi (Takas ise) -->
            <Frame IsVisible="{Binding ShowExchangeField}"
                   Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Entry Placeholder="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[WhatToExchange]}"
                       Text="{Binding ExchangePreference}"
                       FontSize="16" />
            </Frame>

            <!-- Durum -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductCondition]}" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="#666" />

            <Frame Padding="0" 
                   BorderColor="#E0E0E0"
                   CornerRadius="8">
                <Picker ItemsSource="{Binding Conditions}"
                        SelectedItem="{Binding SelectedCondition}"
                        FontSize="16"
                        Title="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[SelectCondition]}">
                    <Picker.ItemDisplayBinding>
                        <Binding>
                            <Binding.Converter>
                                <conv:ProductConditionConverter />
                            </Binding.Converter>
                        </Binding>
                    </Picker.ItemDisplayBinding>
                </Picker>
            </Frame>

            <!-- Konum -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Location]}"
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="#666" />

            <!-- EtkileÅŸimli Harita -->
            <Border StrokeShape="RoundRectangle 12" 
                    StrokeThickness="0"
                    HeightRequest="250"
                    Margin="0,8,0,0">
                <Grid>
                    <mapsui:MapControl x:Name="ProductMap"
                                       VerticalOptions="FillAndExpand"
                                       HorizontalOptions="FillAndExpand" />
                    
                    <!-- Harita Ã¼zerindeki kontrol butonlarÄ± -->
                    <VerticalStackLayout HorizontalOptions="End" 
                                        VerticalOptions="Start"
                                        Margin="12"
                                        Spacing="8">
                        <!-- Mevcut konuma git butonu -->
                        <Border StrokeShape="RoundRectangle 20"
                                BackgroundColor="White"
                                WidthRequest="40"
                                HeightRequest="40"
                                Padding="0">
                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                            </Border.Shadow>
                            <Button Text="ðŸ“"
                                    Command="{Binding UseCurrentLocationCommand}"
                                    FontSize="18"
                                    BackgroundColor="Transparent"
                                    TextColor="#4CAF50"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0"/>
                        </Border>
                    </VerticalStackLayout>
                    
                    <!-- SeÃ§ili konum bilgisi -->
                    <Border StrokeShape="RoundRectangle 12"
                            BackgroundColor="#F5F5F5"
                            Padding="12,8"
                            Margin="12"
                            VerticalOptions="End"
                            HorizontalOptions="FillAndExpand"
                            IsVisible="{Binding HasLocation}">
                        <Border.Shadow>
                            <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                        </Border.Shadow>
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="ðŸ“Œ" 
                                   FontSize="16"
                                   VerticalOptions="Center"/>
                            <Label Text="{Binding Location}"
                                   FontSize="12"
                                   TextColor="#333"
                                   VerticalOptions="Center"
                                   LineBreakMode="TailTruncation"
                                   MaxLines="2"
                                   HorizontalOptions="FillAndExpand"/>
                        </HorizontalStackLayout>
                    </Border>
                </Grid>
            </Border>

            <!-- Konum bilgi metni -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[MapLocationInfo]}"
                   FontSize="12"
                   TextColor="{StaticResource Gray600}"
                   Margin="0,4,0,0"/>

            <!-- GÃ¶rseller -->
            <Label Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[ProductImages]}" 
                   FontSize="16" 
                   FontAttributes="Bold"
                   TextColor="#666" />

            <Button Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[AddImage]}"
                    Command="{Binding PickImagesCommand}"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    CornerRadius="8"
                    HeightRequest="50" />

            <!-- SeÃ§ili GÃ¶rseller -->
            <FlexLayout BindableLayout.ItemsSource="{Binding ImagePaths}"
                        Wrap="Wrap"
                        JustifyContent="Start"
                        AlignItems="Start">
                <BindableLayout.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="5"
                               Margin="5"
                               CornerRadius="8"
                               WidthRequest="100"
                               HeightRequest="100">
                            <Grid>
                                <Image Source="{Binding .}"
                                       Aspect="AspectFill" />
                                <Button Text="âœ•"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:EditProductViewModel}}, Path=RemoveImageCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#F44336"
                                        TextColor="White"
                                        WidthRequest="30"
                                        HeightRequest="30"
                                        CornerRadius="15"
                                        HorizontalOptions="End"
                                        VerticalOptions="Start"
                                        Margin="5" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </FlexLayout>

            <!-- Butonlar -->
            <Grid ColumnDefinitions="*,*" 
                  ColumnSpacing="10"
                  Margin="0,20,0,0">
                <Button Grid.Column="0"
                        Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Cancel]}"
                        Command="{Binding CancelCommand}"
                        BackgroundColor="#757575"
                        TextColor="White"
                        CornerRadius="8"
                        HeightRequest="50" />

                <Button Grid.Column="1"
            Text="{Binding Source={x:Static res:LocalizationResourceManager.Instance}, Path=[Update]}" Command="{Binding SaveProductCommand}" BackgroundColor="#4CAF50"
            TextColor="White"
            CornerRadius="8"
            HeightRequest="50" />
            </Grid>

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                              IsVisible="{Binding IsLoading}"
                              Color="#4CAF50"
                              HeightRequest="50" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>