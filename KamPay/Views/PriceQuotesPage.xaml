<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             x:Class="KamPay.Views.PriceQuotesPage"
             x:DataType="vm:PriceQuotesViewModel"
             Title="Fiyat Teklifleri ðŸ’°">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:IsNotNullOrEmptyConverter x:Key="IsNotNullConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="0">
        
        <!-- Tab Bar -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" 
              HeightRequest="50"
              BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">
            
            <!-- AlÄ±nan Teklifler Tab -->
            <VerticalStackLayout Grid.Column="0" 
                               VerticalOptions="Center"
                               HorizontalOptions="Center"
                               Spacing="4">
                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnReceivedTabTapped" />
                </VerticalStackLayout.GestureRecognizers>
                <Label Text="ðŸ“¥ AlÄ±nan"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />
                <Label Text="{Binding ReceivedQuotes.Count, StringFormat='({0})'}"
                       FontSize="12"
                       HorizontalOptions="Center"
                       TextColor="Gray" />
            </VerticalStackLayout>

            <!-- GÃ¶nderilen Teklifler Tab -->
            <VerticalStackLayout Grid.Column="1" 
                               VerticalOptions="Center"
                               HorizontalOptions="Center"
                               Spacing="4">
                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnSentTabTapped" />
                </VerticalStackLayout.GestureRecognizers>
                <Label Text="ðŸ“¤ GÃ¶nderilen"
                       FontSize="14"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />
                <Label Text="{Binding SentQuotes.Count, StringFormat='({0})'}"
                       FontSize="12"
                       HorizontalOptions="Center"
                       TextColor="Gray" />
            </VerticalStackLayout>
        </Grid>

        <!-- Content Area -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshQuotesCommand}">
            
            <ScrollView>
                <VerticalStackLayout Padding="16" Spacing="16">
                    
                    <!-- Loading Indicator -->
                    <ActivityIndicator IsRunning="{Binding IsLoading}"
                                     IsVisible="{Binding IsLoading}"
                                     Color="#4CAF50"
                                     HeightRequest="50" />

                    <!-- AlÄ±nan Teklifler -->
                    <VerticalStackLayout x:Name="ReceivedQuotesView" Spacing="12">
                        <CollectionView ItemsSource="{Binding ReceivedQuotes}">
                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="40"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                    <Label Text="ðŸ“­"
                                         FontSize="48"
                                         HorizontalOptions="Center" />
                                    <Label Text="HenÃ¼z teklif almadÄ±nÄ±z"
                                         FontSize="16"
                                         HorizontalOptions="Center"
                                         TextColor="Gray"
                                         Margin="0,10,0,0" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:PriceQuote">
                                    <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#2E2E2E}"
                                          BorderColor="Transparent"
                                          Margin="0,0,0,12"
                                          Padding="12"
                                          CornerRadius="12"
                                          HasShadow="True">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=ViewQuoteDetailsCommand}"
                                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="60,*" RowSpacing="8">
                                            
                                            <!-- Thumbnail -->
                                            <Image Grid.Row="0" Grid.RowSpan="3"
                                                 Source="{Binding ReferenceThumbnailUrl}"
                                                 Aspect="AspectFill"
                                                 WidthRequest="60"
                                                 HeightRequest="60"
                                                 VerticalOptions="Start">
                                                <Image.Clip>
                                                    <RoundRectangleGeometry CornerRadius="8"
                                                                          Rect="0,0,60,60" />
                                                </Image.Clip>
                                            </Image>

                                            <!-- Header -->
                                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                                <Label Text="{Binding ReferenceTitle}"
                                                     FontSize="15"
                                                     FontAttributes="Bold"
                                                     LineBreakMode="TailTruncation" />
                                                <Label Text="{Binding BuyerName}"
                                                     FontSize="13"
                                                     TextColor="Gray" />
                                                <Label Text="{Binding TimeAgoText}"
                                                     FontSize="11"
                                                     TextColor="Gray" />
                                            </VerticalStackLayout>

                                            <!-- Price Info -->
                                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="12">
                                                <VerticalStackLayout Spacing="2">
                                                    <Label Text="Orijinal"
                                                         FontSize="10"
                                                         TextColor="Gray" />
                                                    <Label Text="{Binding OriginalPrice, StringFormat='{0:N0} â‚º'}"
                                                         FontSize="12"
                                                         TextDecorations="Strikethrough" />
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Spacing="2">
                                                    <Label Text="Teklif"
                                                         FontSize="10"
                                                         TextColor="Gray" />
                                                    <Label Text="{Binding QuotedPrice, StringFormat='{0:N0} â‚º'}"
                                                         FontSize="14"
                                                         FontAttributes="Bold"
                                                         TextColor="#4CAF50" />
                                                </VerticalStackLayout>
                                            </HorizontalStackLayout>

                                            <!-- Status -->
                                            <Frame Grid.Row="2" Grid.Column="1"
                                                  BackgroundColor="{Binding StatusColor}"
                                                  Padding="8,4"
                                                  CornerRadius="12"
                                                  HasShadow="False"
                                                  HorizontalOptions="Start">
                                                <Label Text="{Binding StatusText}"
                                                     TextColor="White"
                                                     FontSize="10"
                                                     FontAttributes="Bold" />
                                            </Frame>

                                            <!-- Action Buttons -->
                                            <FlexLayout Grid.Row="3" Grid.Column="1"
                                                      Wrap="Wrap"
                                                      JustifyContent="Start"
                                                      AlignItems="Start"
                                                      Direction="Row">
                                                
                                                <Button Text="âœ… Kabul"
                                                      FontSize="11"
                                                      Padding="10,5"
                                                      Margin="0,0,8,0"
                                                      BackgroundColor="#4CAF50"
                                                      TextColor="White"
                                                      CornerRadius="8"
                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=AcceptQuoteCommand}"
                                                      CommandParameter="{Binding .}" />

                                                <Button Text="ðŸ”„ KarÅŸÄ±"
                                                      FontSize="11"
                                                      Padding="10,5"
                                                      Margin="0,0,8,0"
                                                      BackgroundColor="#2196F3"
                                                      TextColor="White"
                                                      CornerRadius="8"
                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=MakeCounterOfferCommand}"
                                                      CommandParameter="{Binding .}" />

                                                <Button Text="âŒ Reddet"
                                                      FontSize="11"
                                                      Padding="10,5"
                                                      BackgroundColor="#F44336"
                                                      TextColor="White"
                                                      CornerRadius="8"
                                                      Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=RejectQuoteCommand}"
                                                      CommandParameter="{Binding .}" />
                                            </FlexLayout>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- GÃ¶nderilen Teklifler -->
                    <VerticalStackLayout x:Name="SentQuotesView" Spacing="12" IsVisible="False">
                        <CollectionView ItemsSource="{Binding SentQuotes}">
                            <CollectionView.EmptyView>
                                <VerticalStackLayout Padding="40"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                    <Label Text="ðŸ“­"
                                         FontSize="48"
                                         HorizontalOptions="Center" />
                                    <Label Text="HenÃ¼z teklif gÃ¶ndermediniz"
                                         FontSize="16"
                                         HorizontalOptions="Center"
                                         TextColor="Gray"
                                         Margin="0,10,0,0" />
                                </VerticalStackLayout>
                            </CollectionView.EmptyView>

                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:PriceQuote">
                                    <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#2E2E2E}"
                                          BorderColor="Transparent"
                                          Margin="0,0,0,12"
                                          Padding="12"
                                          CornerRadius="12"
                                          HasShadow="True">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=ViewQuoteDetailsCommand}"
                                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>

                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="60,*" RowSpacing="8">
                                            
                                            <!-- Thumbnail -->
                                            <Image Grid.Row="0" Grid.RowSpan="3"
                                                 Source="{Binding ReferenceThumbnailUrl}"
                                                 Aspect="AspectFill"
                                                 WidthRequest="60"
                                                 HeightRequest="60"
                                                 VerticalOptions="Start">
                                                <Image.Clip>
                                                    <RoundRectangleGeometry CornerRadius="8"
                                                                          Rect="0,0,60,60" />
                                                </Image.Clip>
                                            </Image>

                                            <!-- Header -->
                                            <VerticalStackLayout Grid.Row="0" Grid.Column="1" Spacing="4">
                                                <Label Text="{Binding ReferenceTitle}"
                                                     FontSize="15"
                                                     FontAttributes="Bold"
                                                     LineBreakMode="TailTruncation" />
                                                <Label Text="{Binding SellerName, StringFormat='SatÄ±cÄ±: {0}'}"
                                                     FontSize="13"
                                                     TextColor="Gray" />
                                                <Label Text="{Binding TimeAgoText}"
                                                     FontSize="11"
                                                     TextColor="Gray" />
                                            </VerticalStackLayout>

                                            <!-- Price Info -->
                                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="12">
                                                <VerticalStackLayout Spacing="2">
                                                    <Label Text="Orijinal"
                                                         FontSize="10"
                                                         TextColor="Gray" />
                                                    <Label Text="{Binding OriginalPrice, StringFormat='{0:N0} â‚º'}"
                                                         FontSize="12"
                                                         TextDecorations="Strikethrough" />
                                                </VerticalStackLayout>

                                                <VerticalStackLayout Spacing="2">
                                                    <Label Text="Teklifiniz"
                                                         FontSize="10"
                                                         TextColor="Gray" />
                                                    <Label Text="{Binding QuotedPrice, StringFormat='{0:N0} â‚º'}"
                                                         FontSize="14"
                                                         FontAttributes="Bold"
                                                         TextColor="#4CAF50" />
                                                </VerticalStackLayout>
                                            </HorizontalStackLayout>

                                            <!-- Status -->
                                            <Frame Grid.Row="2" Grid.Column="1"
                                                  BackgroundColor="{Binding StatusColor}"
                                                  Padding="8,4"
                                                  CornerRadius="12"
                                                  HasShadow="False"
                                                  HorizontalOptions="Start">
                                                <Label Text="{Binding StatusText}"
                                                     TextColor="White"
                                                     FontSize="10"
                                                     FontAttributes="Bold" />
                                            </Frame>

                                            <!-- Action Button -->
                                            <Button Grid.Row="3" Grid.Column="1"
                                                  Text="ðŸ—‘ï¸ Ä°ptal Et"
                                                  FontSize="11"
                                                  Padding="10,5"
                                                  HorizontalOptions="Start"
                                                  BackgroundColor="Gray"
                                                  TextColor="White"
                                                  CornerRadius="8"
                                                  Command="{Binding Source={RelativeSource AncestorType={x:Type vm:PriceQuotesViewModel}}, Path=CancelQuoteCommand}"
                                                  CommandParameter="{Binding .}" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>
</ContentPage>
