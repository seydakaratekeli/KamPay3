<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             x:Class="KamPay.Views.ServiceSharingPage"
             x:DataType="vm:ServiceSharingViewModel"
             BackgroundColor="{StaticResource Gray100}">

    <!-- Sayfa iÃ§i sadece ihtiyaÃ§ olan converter'lar -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:ServiceCategoryToTextConverter x:Key="ServiceCategoryToTextConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- 2 satÄ±r: 0 = Filtre Bar, 1 = AsÄ±l iÃ§erik -->
    <Grid RowDefinitions="Auto,*">

        <!-- ========================================================= -->
        <!-- ðŸ”  FILTRE BAR (Sadece liste gÃ¶rÃ¼nÃ¼rken)                  -->
        <!-- ========================================================= -->
        <VerticalStackLayout Grid.Row="0"
                             Padding="10"
                             Spacing="8"
                             BackgroundColor="{StaticResource Gray100}"
                             IsVisible="{Binding IsPostFormVisible, Converter={StaticResource InverseBoolConverter}}">

            <!-- Arama -->
            <Border StrokeThickness="0"
                    BackgroundColor="White"
                    Padding="8"
                    StrokeShape="RoundRectangle 10">
                <Entry Placeholder="Hizmet ara..."
                       Text="{Binding SearchText}"
                       ClearButtonVisibility="WhileEditing"
                       FontSize="15" />
            </Border>

            <!-- Kategori filtresi -->
            <Border StrokeThickness="0"
                    BackgroundColor="White"
                    Padding="8,4"
                    StrokeShape="RoundRectangle 10">
                <Grid ColumnDefinitions="Auto,*">
                    <Label Text="Kategori"
                           FontSize="13"
                           TextColor="{StaticResource Gray600}"
                           VerticalOptions="Center" />
                    <Picker Grid.Column="1"
                            Title="Kategori SeÃ§iniz"
                            ItemsSource="{Binding Categories}"
                            SelectedItem="{Binding FilterCategory}">
                        <Picker.ItemDisplayBinding>
                            <Binding Converter="{StaticResource ServiceCategoryToTextConverter}" />
                        </Picker.ItemDisplayBinding>
                    </Picker>
                </Grid>
            </Border>

            <!-- Fiyat sÄ±ralama -->
            <Border StrokeThickness="0"
                    BackgroundColor="White"
                    Padding="8,4"
                    StrokeShape="RoundRectangle 10">
                <Grid ColumnDefinitions="Auto,*">
                    <Label Text="Fiyat sÄ±ralama"
                           FontSize="13"
                           TextColor="{StaticResource Gray600}"
                           VerticalOptions="Center" />
                    <Picker Grid.Column="1"
                            Title="Fiyat"
                            SelectedItem="{Binding PriceSort}">
                        <Picker.Items>
                            <!-- boÅŸ = tarihine gÃ¶re -->
                            <x:String>Hepsi</x:String>
                            <x:String>Artan</x:String>
                            <x:String>Azalan</x:String>
                        </Picker.Items>
                    </Picker>
                </Grid>
            </Border>

        </VerticalStackLayout>

        <!-- ========================================================= -->
        <!--  ANA Ä°Ã‡ERÄ°K (Liste + Skeleton + Form + FAB)               -->
        <!-- ========================================================= -->
        <Grid Grid.Row="1">

            <!-- ðŸ”¥ SKELETON LOADER -->
            <ScrollView IsVisible="{Binding IsLoading}"
                        BackgroundColor="{StaticResource Gray100}"
                        Padding="10">
                <VerticalStackLayout Spacing="10">
                    <Frame CornerRadius="15" HeightRequest="150"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                    <Frame CornerRadius="15" HeightRequest="150"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                    <Frame CornerRadius="15" HeightRequest="150"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                </VerticalStackLayout>
            </ScrollView>

            <!-- ðŸ”¥ REFRESH + FILTERED LIST -->
            <RefreshView Command="{Binding RefreshServicesCommand}"
                         IsRefreshing="{Binding IsRefreshing}"
                         IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                         RefreshColor="{StaticResource Primary}">

                <CollectionView ItemsSource="{Binding FilteredServices}"
                                Margin="10,0"
                                SelectionMode="None">

                    <!-- HEADER -->
                    <CollectionView.Header>
                        <Label Text="Mevcut Hizmetler"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Primary}"
                               Margin="10,15" />
                    </CollectionView.Header>

                    <!-- EMPTY VIEW -->
                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="40"
                                             VerticalOptions="Center"
                                             HorizontalOptions="Center"
                                             Spacing="15">
                            <Label Text="ðŸ’¼"
                                   FontSize="60"
                                   Opacity="0.3"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="SonuÃ§ bulunamadÄ±."
                                   FontSize="17"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray600}"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="Filtreleri deÄŸiÅŸtirin veya aramayÄ± temizleyin."
                                   FontSize="14"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <!-- ITEM TEMPLATE -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:ServiceOffer">

                            <Frame Margin="0,8"
                                   Padding="15"
                                   BorderColor="{StaticResource Gray200}"
                                   CornerRadius="15"
                                   BackgroundColor="White"
                                   HasShadow="True">

                                <VerticalStackLayout Spacing="10">

                                    <!-- Title + Category -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Text="{Binding Title}"
                                               FontAttributes="Bold"
                                               FontSize="18"
                                               TextColor="{StaticResource Gray900}"
                                               LineBreakMode="TailTruncation" />

                                        <Border Grid.Column="1"
                                                BackgroundColor="{StaticResource Gray200}"
                                                Padding="10,5"
                                                StrokeShape="RoundRectangle 8">
                                            <Label Text="{Binding Category, Converter={StaticResource ServiceCategoryToTextConverter}}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Primary}"
                                                   FontAttributes="Bold" />
                                        </Border>
                                    </Grid>

                                    <!-- Description -->
                                    <Label Text="{Binding Description}"
                                           TextColor="{StaticResource Gray600}"
                                           LineBreakMode="WordWrap"
                                           FontSize="14" />

                                    <BoxView HeightRequest="1"
                                             Color="{StaticResource Gray200}"
                                             Margin="0,5" />

                                    <!-- PRICE + PROVIDER + REQUEST BUTTON -->
                                    <Grid ColumnDefinitions="*,Auto">

                                        <!-- PROVIDER -->
                                        <HorizontalStackLayout Grid.Column="0"
                                                               Spacing="10"
                                                               VerticalOptions="Center">
                                            <ffimageloading:CachedImage
                                                Source="{Binding ProviderPhotoUrl}"
                                                Aspect="AspectFill"
                                                HeightRequest="40"
                                                WidthRequest="40"
                                                LoadingPlaceholder="person_icon.svg"
                                                ErrorPlaceholder="person_icon.svg">
                                                <ffimageloading:CachedImage.Clip>
                                                    <EllipseGeometry Center="20,20"
                                                                     RadiusX="20"
                                                                     RadiusY="20" />
                                                </ffimageloading:CachedImage.Clip>
                                            </ffimageloading:CachedImage>

                                            <VerticalStackLayout>
                                                <Label Text="{Binding ProviderName}"
                                                       FontAttributes="Bold"
                                                       FontSize="14"
                                                       TextColor="{StaticResource Gray900}" />
                                                <Label Text="{Binding CreatedAt, Converter={StaticResource DateTimeToTimeAgoConverter}}"
                                                       FontSize="11"
                                                       TextColor="{StaticResource Gray500}" />
                                            </VerticalStackLayout>
                                        </HorizontalStackLayout>

                                        <!-- PRICE + BUTTONS -->
                                        <HorizontalStackLayout Grid.Column="1"
                                                               Spacing="8"
                                                               VerticalOptions="Center">
                                            <VerticalStackLayout Spacing="2">
                                                <Label Text="{Binding Price, StringFormat='{0} â‚º'}"
                                                       FontAttributes="Bold"
                                                       FontSize="16"
                                                       TextColor="{StaticResource Primary}" />
                                                <Label Text="{Binding TimeCredits, StringFormat='â± {0} Saat'}"
                                                       FontSize="12"
                                                       TextColor="{StaticResource Secondary}" />
                                            </VerticalStackLayout>

                                            <!-- ðŸ”¥ YENÄ°: Mesaj Butonu -->
                                            <Button Text="ðŸ’¬"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceSharingViewModel}}, Path=MessageProviderCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{StaticResource Secondary}"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    HeightRequest="40"
                                                    WidthRequest="40"
                                                    FontSize="18"
                                                    ToolTipProperties.Text="SatÄ±cÄ±ya Mesaj GÃ¶nder" />

                                            <Button Text="Talep Et"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceSharingViewModel}}, Path=RequestServiceCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    Padding="15,0"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    HeightRequest="40"
                                                    FontAttributes="Bold" />
                                        </HorizontalStackLayout>

                                    </Grid>

                                </VerticalStackLayout>
                            </Frame>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>
            </RefreshView>

            <!-- ========================================================= -->
            <!--  ðŸ”¥ YENÄ° HÄ°ZMET FORMU (POPUP)                            -->
            <!-- ========================================================= -->
            <Grid IsVisible="{Binding IsPostFormVisible}"
                  BackgroundColor="#80000000"
                  ZIndex="99">

                <!-- DÄ±ÅŸa tÄ±klayÄ±nca kapansÄ±n -->
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ClosePostFormCommand}" />
                </Grid.GestureRecognizers>

                <!-- Alt taraftan Ã§Ä±kan panel -->
                <Border BackgroundColor="White"
                        VerticalOptions="End"
                        StrokeShape="RoundRectangle 20"
                        Padding="20"
                        Margin="10,0,10,10">

                    <ScrollView>
                        <VerticalStackLayout Spacing="15">

                            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">

                                <Label Text="Yeni Hizmet PaylaÅŸ"
                  Grid.Column="0"
                  FontSize="20"
                  FontAttributes="Bold"
                  TextColor="{StaticResource Gray900}" 
                  VerticalOptions="Center"/>

                                <Button Text="âœ•"
                   Grid.Column="1" 
                   Command="{Binding ClosePostFormCommand}"
                   BackgroundColor="Transparent"
                   TextColor="{StaticResource Gray600}"
                   FontSize="22"
                   Padding="0"
                   WidthRequest="40"
                   HeightRequest="40"
                   VerticalOptions="Center"/>
                            </Grid>

                            <BoxView HeightRequest="1"
                Color="{StaticResource Gray300}" />

                            <!-- Hizmet BaÅŸlÄ±ÄŸÄ± -->
                            <VerticalStackLayout Spacing="3">
                                <Label Text="BaÅŸlÄ±k"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                                <Entry Placeholder="Ã–rneÄŸin: MÃ¼zik dersi"
                                       Text="{Binding ServiceTitle}"
                                       FontSize="14" />
                            </VerticalStackLayout>

                            <!-- Hizmet AÃ§Ä±klamasÄ± -->
                            <VerticalStackLayout Spacing="3">
                                <Label Text="Detaylar"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                                <Border Stroke="{StaticResource Gray300}"
                                        StrokeShape="RoundRectangle 10"
                                        Padding="10">
                                    <Editor Placeholder="Hizmet aÃ§Ä±klamasÄ±..."
                                            Text="{Binding ServiceDescription}"
                                            HeightRequest="80"
                                            AutoSize="TextChanges" />
                                </Border>
                            </VerticalStackLayout>

                            <!-- Kategori -->
                            <VerticalStackLayout Spacing="3">
                                <Label Text="Kategori"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray600}" />
                                <Border Stroke="{StaticResource Gray300}"
                                        StrokeShape="RoundRectangle 10"
                                        Padding="6,0">
                                    <Picker Title="Kategori"
                                            ItemsSource="{Binding Categories}"
                                            SelectedItem="{Binding SelectedCategory}">
                                        <Picker.ItemDisplayBinding>
                                            <Binding Converter="{StaticResource ServiceCategoryToTextConverter}" />
                                        </Picker.ItemDisplayBinding>
                                    </Picker>
                                </Border>
                            </VerticalStackLayout>

                            <!-- Fiyat + SÃ¼re (ALT ALTA, KESÄ°NLÄ°KLE TASMA YAPMAZ) -->
                            <VerticalStackLayout Spacing="15">

                                <!-- Fiyat -->
                                <VerticalStackLayout Spacing="3">
                                    <Label Text="Fiyat (â‚º)"
               FontSize="12"
               TextColor="{StaticResource Gray600}" />
                                    <Border Stroke="{StaticResource Gray300}"
                StrokeShape="RoundRectangle 10"
                Padding="6,4">
                                        <Entry Text="{Binding ServicePrice}"
                   Placeholder="0"
                   Keyboard="Numeric"
                   FontSize="14" />
                                    </Border>
                                </VerticalStackLayout>

                                <!-- SÃ¼re (Saat) -->
                                <VerticalStackLayout Spacing="5">

                                    <Label Text="SÃ¼re (Saat)"
           FontSize="12"
           TextColor="{StaticResource Gray600}" />

                                    <Border Stroke="{StaticResource Gray300}"
            StrokeShape="RoundRectangle 10"
            Padding="12">
                                        <!-- DAHA GENÄ°Åž Ä°Ã‡ BOÅžLUK -->

                                        <Grid ColumnDefinitions="Auto,*,Auto"
              HorizontalOptions="Center"
              VerticalOptions="Center"
              ColumnSpacing="25">
                                            <!-- BUTONLAR ARASI MESAFE -->

                                            <!-- â€“ BUTONU -->
                                            <Button Grid.Column="0"
                    Text="-"
                    WidthRequest="45"
                    HeightRequest="45"
                    CornerRadius="12"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="20"
                    Command="{Binding DecrementTimeCreditsCommand}" />

                                            <!-- ORTADAKÄ° DEÄžER -->
                                            <Label Grid.Column="1"
                   Text="{Binding TimeCredits}"
                   FontSize="20"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   VerticalOptions="Center" />

                                            <!-- + BUTONU -->
                                            <Button Grid.Column="2"
                    Text="+"
                    WidthRequest="45"
                    HeightRequest="45"
                    CornerRadius="12"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="20"
                    Command="{Binding IncrementTimeCreditsCommand}" />

                                        </Grid>

                                    </Border>

                                </VerticalStackLayout>

                            </VerticalStackLayout>

                            <!-- PaylaÅŸ Butonu -->
                            <Button Text="Hizmeti PaylaÅŸ"
                                    Command="{Binding CreateServiceCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    CornerRadius="10"
                                    HeightRequest="50"
                                    FontAttributes="Bold" />

                        </VerticalStackLayout>
                    </ScrollView>

                </Border>
            </Grid>

            <!-- ========================================================= -->
            <!--  ðŸ”¥ POSTING OVERLAY                                      -->
            <!-- ========================================================= -->
            <Grid IsVisible="{Binding IsPosting}"
                  BackgroundColor="#80000088"
                  ZIndex="100">
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="10">
                    <ActivityIndicator IsRunning="True"
                                       Color="White"
                                       WidthRequest="50" />
                    <Label Text="Ä°ÅŸlem yapÄ±lÄ±yor..."
                           TextColor="White" />
                </VerticalStackLayout>
            </Grid>

            <!-- ========================================================= -->
            <!--  ðŸ”¥ FAB BUTTON (+)                                        -->
            <!-- ========================================================= -->
            <Button Text="+"
                    Command="{Binding OpenPostFormCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="32"
                    CornerRadius="30"
                    WidthRequest="60"
                    HeightRequest="60"
                    Padding="0"
                    VerticalOptions="End"
                    HorizontalOptions="End"
                    Margin="25"
                    ZIndex="10">
                <Button.Shadow>
                    <Shadow Brush="Black"
                            Offset="0,5"
                            Opacity="0.3"
                            Radius="8" />
                </Button.Shadow>
            </Button>

        </Grid>

    </Grid>

</ContentPage>
