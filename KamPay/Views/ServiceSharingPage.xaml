<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             x:Class="KamPay.Views.ServiceSharingPage"
             x:DataType="vm:ServiceSharingViewModel"
             BackgroundColor="{StaticResource Gray100}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:ServiceCategoryToTextConverter x:Key="ServiceCategoryToTextConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- ðŸ” FILTRE BAR -->
        <VerticalStackLayout Grid.Row="0"
                             Padding="12"
                             Spacing="10"
                             BackgroundColor="{StaticResource Gray100}"
                             IsVisible="{Binding IsPostFormVisible, Converter={StaticResource InverseBoolConverter}}">

            <!-- Arama -->
            <Border StrokeThickness="0"
                    BackgroundColor="White"
                    Padding="10"
                    StrokeShape="RoundRectangle 12">
                <Entry Placeholder="Hizmet ara..."
                       Text="{Binding SearchText}"
                       ClearButtonVisibility="WhileEditing"
                       FontSize="15" />
            </Border>

            <!-- Kategori ve Fiyat SÄ±ralama (Yan Yana - Responsive) -->
            <Grid ColumnDefinitions="*,*"
                  ColumnSpacing="10">

                <!-- Kategori -->
                <Border Grid.Column="0"
                        StrokeThickness="0"
                        BackgroundColor="White"
                        Padding="8,0"
                        StrokeShape="RoundRectangle 12">
                    <Picker Title="Kategori"
                            ItemsSource="{Binding Categories}"
                            SelectedItem="{Binding FilterCategory}"
                            FontSize="13">
                        <Picker.ItemDisplayBinding>
                            <Binding Converter="{StaticResource ServiceCategoryToTextConverter}" />
                        </Picker.ItemDisplayBinding>
                    </Picker>
                </Border>

                <!-- Fiyat SÄ±ralama -->
                <Border Grid.Column="1"
                        StrokeThickness="0"
                        BackgroundColor="White"
                        Padding="8,0"
                        StrokeShape="RoundRectangle 12">
                    <Picker Title="Fiyat"
                            SelectedItem="{Binding PriceSort}"
                            FontSize="13">
                        <Picker.Items>
                            <x:String>Hepsi</x:String>
                            <x:String>Artan</x:String>
                            <x:String>Azalan</x:String>
                        </Picker.Items>
                    </Picker>
                </Border>

            </Grid>

        </VerticalStackLayout>

        <!-- ANA Ä°Ã‡ERÄ°K -->
        <Grid Grid.Row="1">

            <!-- SKELETON LOADER -->
            <ScrollView IsVisible="{Binding IsLoading}"
                        BackgroundColor="{StaticResource Gray100}"
                        Padding="12">
                <VerticalStackLayout Spacing="12">
                    <Frame CornerRadius="15" HeightRequest="140"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                    <Frame CornerRadius="15" HeightRequest="140"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                    <Frame CornerRadius="15" HeightRequest="140"
                           BackgroundColor="{StaticResource Gray200}" Opacity="0.6" />
                </VerticalStackLayout>
            </ScrollView>

            <!-- REFRESH + LIST -->
            <RefreshView Command="{Binding RefreshServicesCommand}"
                         IsRefreshing="{Binding IsRefreshing}"
                         IsVisible="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                         RefreshColor="{StaticResource Primary}">

                <CollectionView ItemsSource="{Binding FilteredServices}"
                                Margin="12,0"
                                SelectionMode="None">

                    <CollectionView.Header>
                        <Label Text="Mevcut Hizmetler"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Primary}"
                               Margin="0,15,0,10" />
                    </CollectionView.Header>

                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="40"
                                             VerticalOptions="Center"
                                             HorizontalOptions="Center"
                                             Spacing="15">
                            <Label Text="ðŸ’¼" FontSize="60" Opacity="0.3" HorizontalTextAlignment="Center" />
                            <Label Text="SonuÃ§ bulunamadÄ±."
                                   FontSize="17" FontAttributes="Bold"
                                   TextColor="{StaticResource Gray600}"
                                   HorizontalTextAlignment="Center" />
                            <Label Text="Filtreleri deÄŸiÅŸtirin veya aramayÄ± temizleyin."
                                   FontSize="14" TextColor="{StaticResource Primary}"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <!-- ITEM TEMPLATE - DÃœZELTÄ°LMÄ°Åž -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:ServiceOffer">

                            <Frame Margin="0,0,0,12"
                                   Padding="15"
                                   BorderColor="{StaticResource Gray200}"
                                   CornerRadius="15"
                                   BackgroundColor="White"
                                   HasShadow="True">

                                <Grid RowDefinitions="Auto,Auto,Auto,1,Auto"
                                      RowSpacing="10">

                                    <!-- ROW 0: Title + Category -->
                                    <Grid Grid.Row="0"
                                          ColumnDefinitions="*,Auto"
                                          ColumnSpacing="10">
                                        
                                        <Label Grid.Column="0"
                                               Text="{Binding Title}"
                                               FontAttributes="Bold"
                                               FontSize="17"
                                               TextColor="{StaticResource Gray900}"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2"
                                               VerticalOptions="Center" />

                                        <Border Grid.Column="1"
                                                BackgroundColor="{StaticResource Gray200}"
                                                Padding="8,4"
                                                StrokeShape="RoundRectangle 8"
                                                VerticalOptions="Start">
                                            <Label Text="{Binding Category, Converter={StaticResource ServiceCategoryToTextConverter}}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Primary}"
                                                   FontAttributes="Bold" />
                                        </Border>
                                    </Grid>

                                    <!-- ROW 1: Description -->
                                    <Label Grid.Row="1"
                                           Text="{Binding Description}"
                                           TextColor="{StaticResource Gray600}"
                                           LineBreakMode="WordWrap"
                                           MaxLines="3"
                                           FontSize="13" />

                                    <!-- ROW 2: Provider Info -->
                                    <Grid Grid.Row="2"
                                          ColumnDefinitions="Auto,*"
                                          ColumnSpacing="10">

                                        <ffimageloading:CachedImage Grid.Column="0"
                                            Source="{Binding ProviderPhotoUrl}"
                                            Aspect="AspectFill"
                                            HeightRequest="36"
                                            WidthRequest="36"
                                            LoadingPlaceholder="person_icon.svg"
                                            ErrorPlaceholder="person_icon.svg"
                                            VerticalOptions="Center">
                                            <ffimageloading:CachedImage.Clip>
                                                <EllipseGeometry Center="18,18" RadiusX="18" RadiusY="18" />
                                            </ffimageloading:CachedImage.Clip>
                                        </ffimageloading:CachedImage>

                                        <VerticalStackLayout Grid.Column="1"
                                                             Spacing="2"
                                                             VerticalOptions="Center">
                                            <Label Text="{Binding ProviderName}"
                                                   FontAttributes="Bold"
                                                   FontSize="13"
                                                   TextColor="{StaticResource Gray900}"
                                                   LineBreakMode="TailTruncation" />
                                            <Label Text="{Binding CreatedAt, Converter={StaticResource DateTimeToTimeAgoConverter}}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Gray500}" />
                                        </VerticalStackLayout>
                                    </Grid>

                                    <!-- ROW 3: Divider -->
                                    <BoxView Grid.Row="3"
                                             HeightRequest="1"
                                             Color="{StaticResource Gray200}" />

                                    <!-- ROW 4: Price + Actions -->
                                    <Grid Grid.Row="4"
                                          ColumnDefinitions="Auto,*"
                                          ColumnSpacing="10">

                                        <!-- Price + Time Credits -->
                                        <VerticalStackLayout Grid.Column="0"
                                                             Spacing="3"
                                                             VerticalOptions="Center">
                                            <Label Text="{Binding Price, StringFormat='{0} â‚º'}"
                                                   FontAttributes="Bold"
                                                   FontSize="18"
                                                   TextColor="{StaticResource Primary}" />
                                            <Label Text="{Binding TimeCredits, StringFormat='â± {0} Saat'}"
                                                   FontSize="11"
                                                   TextColor="{StaticResource Secondary}" />
                                        </VerticalStackLayout>

                                        <!-- Action Buttons -->
                                        <HorizontalStackLayout Grid.Column="1"
                                                               Spacing="8"
                                                               HorizontalOptions="End"
                                                               VerticalOptions="Center">
                                            
                                            <!-- Mesaj Butonu -->
                                            <Button Text="ðŸ’¬"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceSharingViewModel}}, Path=MessageProviderCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{StaticResource Secondary}"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    HeightRequest="38"
                                                    WidthRequest="38"
                                                    FontSize="16"
                                                    Padding="0"
                                                    ToolTipProperties.Text="Mesaj GÃ¶nder" />

                                            <!-- Talep Et Butonu -->
                                            <Button Text="Talep Et"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ServiceSharingViewModel}}, Path=RequestServiceCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    Padding="12,0"
                                                    TextColor="White"
                                                    CornerRadius="10"
                                                    HeightRequest="38"
                                                    FontSize="13"
                                                    FontAttributes="Bold" />
                                        </HorizontalStackLayout>

                                    </Grid>

                                </Grid>
                            </Frame>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>
            </RefreshView>

            <!-- YENÄ° HÄ°ZMET FORMU -->
            <Grid IsVisible="{Binding IsPostFormVisible}"
                  BackgroundColor="#80000000"
                  ZIndex="99">

                <Grid.InputTransparent>
                    False
                </Grid.InputTransparent>
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ClosePostFormCommand}" />
                </Grid.GestureRecognizers>

                <ContentView IsVisible="{Binding IsPostFormVisible}" BackgroundColor="#80000080" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" ZIndex="99">
                    <Grid VerticalOptions="End">
                        <Border BackgroundColor="White"
                                StrokeShape="RoundRectangle 24,24,0,0"
                                Padding="24,30"
                                VerticalOptions="End">
                            <VerticalStackLayout Spacing="18">
                                <!-- Panel BaÅŸlÄ±ÄŸÄ± ve Kapat -->
                                <Grid>
                                    <Label Text="Yeni Hizmet PaylaÅŸ" FontSize="20" FontAttributes="Bold" HorizontalOptions="Center"/>
                                    <Button Text="âœ•"
                                            Command="{Binding ClosePostFormCommand}"
                                            HorizontalOptions="End"
                                            BackgroundColor="Transparent"
                                            TextColor="Gray"
                                            FontSize="18"
                                            Padding="0"
                                            HeightRequest="30"/>
                                </Grid>

                                <BoxView HeightRequest="1" Color="#EEEEEE" />

                                <!-- BaÅŸlÄ±k -->
                                <Entry Placeholder="Hizmet BaÅŸlÄ±ÄŸÄ±"
                                       Text="{Binding ServiceTitle}"
                                       FontSize="16"
                                       Margin="0,0,0,0"/>

                                <!-- AÃ§Ä±klama -->
                                <Editor Placeholder="AÃ§Ä±klama"
                                        Text="{Binding ServiceDescription}"
                                        FontSize="15"
                                        AutoSize="TextChanges"
                                        Margin="0,0,0,0"/>

                                <!-- Kategori -->
                                <Picker Title="Kategori SeÃ§in"
                                        ItemsSource="{Binding Categories}"
                                        SelectedItem="{Binding SelectedCategory}"
                                        Margin="0,0,0,0"/>

                                <!-- Fiyat -->
                                <Entry Placeholder="Fiyat (â‚º)"
                                       Text="{Binding ServicePrice}"
                                       Keyboard="Numeric"
                                       FontSize="16"
                                       Margin="0,0,0,0"/>

                                <!-- Zaman Kredisi (SÃ¼re) -->
                                <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,0" VerticalOptions="Center">
                                    <Button Text="âˆ’" Command="{Binding DecrementTimeCreditsCommand}" WidthRequest="36" HeightRequest="36"
                                            FontSize="22" BackgroundColor="#F5F5F5" TextColor="#4CAF50" CornerRadius="18"/>
                                    <VerticalStackLayout>
                                        <Label Text="SÃ¼re (Zaman Kredisi)" FontSize="13" TextColor="#757575" HorizontalOptions="Center"/>
                                        <Label Text="{Binding TimeCredits}" FontSize="18" FontAttributes="Bold" TextColor="#4CAF50" HorizontalOptions="Center"/>
                                        <Label Text="Saat" FontSize="12" TextColor="#757575" HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                    <Button Text="+" Command="{Binding IncrementTimeCreditsCommand}" WidthRequest="36" HeightRequest="36"
                                            FontSize="22" BackgroundColor="#F5F5F5" TextColor="#4CAF50" CornerRadius="18"/>
                                </Grid>

                                <!-- Kaydet Butonu -->
                                <Button Text="PaylaÅŸ"
                                        Command="{Binding CreateServiceCommand}"
                                        BackgroundColor="#4CAF50"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        CornerRadius="12"
                                        HeightRequest="48"
                                        Margin="0,10,0,0"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>
                </ContentView>
            </Grid>

            <!-- POSTING OVERLAY -->
            <Grid IsVisible="{Binding IsPosting}"
                  BackgroundColor="#80000088"
                  ZIndex="100">
                <VerticalStackLayout VerticalOptions="Center"
                                     HorizontalOptions="Center"
                                     Spacing="10">
                    <ActivityIndicator IsRunning="True" Color="White" WidthRequest="50" />
                    <Label Text="Ä°ÅŸlem yapÄ±lÄ±yor..." TextColor="White" FontSize="15" />
                </VerticalStackLayout>
            </Grid>

            <!-- FAB BUTTON -->
            <Button Text="+"
                    Command="{Binding OpenPostFormCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontSize="32"
                    CornerRadius="30"
                    WidthRequest="60"
                    HeightRequest="60"
                    Padding="0"
                    VerticalOptions="End"
                    HorizontalOptions="End"
                    Margin="20"
                    ZIndex="10">
                <Button.Shadow>
                    <Shadow Brush="Black" Offset="0,5" Opacity="0.3" Radius="8" />
                </Button.Shadow>
            </Button>

        </Grid>

        <!-- FÄ°LTRE/EKLEME PANELÄ° (Alt kÄ±sÄ±mdan aÃ§Ä±lan) -->
        <Grid Grid.RowSpan="3" 
              BackgroundColor="#80000000" 
              IsVisible="{Binding IsPostFormVisible}"
              ZIndex="99">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ClosePostFormCommand}" />
            </Grid.GestureRecognizers>

            <Border BackgroundColor="White" 
                    VerticalOptions="End" 
                    StrokeShape="RoundRectangle 24,24,0,0"
                    Padding="24,30">
                <Border.GestureRecognizers>
                    <TapGestureRecognizer />
                </Border.GestureRecognizers>
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="0,-4" Radius="15" Opacity="0.2"/>
                </Border.Shadow>

                <ScrollView>
                    <VerticalStackLayout Spacing="18">
                        <!-- Panel BaÅŸlÄ±ÄŸÄ± ve Kapat -->
                        <Grid>
                            <Label Text="Yeni Hizmet PaylaÅŸ" 
                                   FontSize="20" 
                                   FontAttributes="Bold" 
                                   HorizontalOptions="Center"
                                   TextColor="#212121"/>
                            <Button Text="âœ•"
                                    Command="{Binding ClosePostFormCommand}"
                                    HorizontalOptions="End"
                                    BackgroundColor="Transparent"
                                    TextColor="#757575"
                                    FontSize="18"
                                    Padding="0"
                                    HeightRequest="30"/>
                        </Grid>

                        <BoxView HeightRequest="1" Color="#EEEEEE" />

                        <!-- BaÅŸlÄ±k -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Hizmet BaÅŸlÄ±ÄŸÄ±" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#212121"/>
                            <Border StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="1" 
                                    Stroke="#E0E0E0"
                                    Padding="12,8">
                                <Entry Placeholder="Ã–rn: BahÃ§e BakÄ±mÄ±, Temizlik..."
                                       Text="{Binding ServiceTitle}"
                                       FontSize="15"
                                       TextColor="#212121"
                                       PlaceholderColor="#9E9E9E"/>
                            </Border>
                        </VerticalStackLayout>

                        <!-- AÃ§Ä±klama -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="AÃ§Ä±klama" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#212121"/>
                            <Border StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="1" 
                                    Stroke="#E0E0E0"
                                    Padding="12,8">
                                <Editor Placeholder="Hizmetinizin detaylarÄ±nÄ± yazÄ±n..."
                                        Text="{Binding ServiceDescription}"
                                        FontSize="15"
                                        TextColor="#212121"
                                        PlaceholderColor="#9E9E9E"
                                        AutoSize="TextChanges"
                                        MinimumHeightRequest="80"/>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Kategori -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Kategori" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#212121"/>
                            <Border StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="1" 
                                    Stroke="#E0E0E0"
                                    Padding="12,0">
                                <Picker Title="Kategori SeÃ§in"
                                        ItemsSource="{Binding Categories}"
                                        SelectedItem="{Binding SelectedCategory}"
                                        FontSize="15"
                                        TextColor="#212121"
                                        TitleColor="#9E9E9E"/>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Fiyat -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Fiyat" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#212121"/>
                            <Border StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="1" 
                                    Stroke="#E0E0E0"
                                    Padding="12,8">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Entry Placeholder="0"
                                           Text="{Binding ServicePrice}"
                                           Keyboard="Numeric"
                                           FontSize="15"
                                           TextColor="#212121"
                                           PlaceholderColor="#9E9E9E"/>
                                    <Label Grid.Column="1" 
                                           Text="â‚º" 
                                           FontSize="15" 
                                           FontAttributes="Bold"
                                           TextColor="#4CAF50"
                                           VerticalOptions="Center"/>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>

                        <!-- Zaman Kredisi (SÃ¼re) -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="SÃ¼re (Zaman Kredisi)" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#212121"/>
                            <Border StrokeShape="RoundRectangle 12" 
                                    StrokeThickness="1" 
                                    Stroke="#E0E0E0"
                                    Padding="16,12">
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                    <Button Text="âˆ’" 
                                            Command="{Binding DecrementTimeCreditsCommand}" 
                                            WidthRequest="40" 
                                            HeightRequest="40"
                                            FontSize="24" 
                                            BackgroundColor="#F5F5F5" 
                                            TextColor="#4CAF50" 
                                            CornerRadius="20"
                                            Padding="0"/>
                                    <VerticalStackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                                        <Label Text="{Binding TimeCredits}" 
                                               FontSize="24" 
                                               FontAttributes="Bold" 
                                               TextColor="#4CAF50" 
                                               HorizontalOptions="Center"/>
                                        <Label Text="Saat" 
                                               FontSize="12" 
                                               TextColor="#757575" 
                                               HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                    <Button Grid.Column="2" 
                                            Text="+" 
                                            Command="{Binding IncrementTimeCreditsCommand}" 
                                            WidthRequest="40" 
                                            HeightRequest="40"
                                            FontSize="22" 
                                            BackgroundColor="#F5F5F5" 
                                            TextColor="#4CAF50" 
                                            CornerRadius="20"
                                            Padding="0"/>
                                </Grid>
                            </Border>
                        </VerticalStackLayout>

                        <!-- YÃ¼kleniyor GÃ¶stergesi -->
                        <ActivityIndicator IsRunning="{Binding IsPosting}" 
                                           IsVisible="{Binding IsPosting}"
                                           Color="#4CAF50"
                                           HeightRequest="40"/>

                        <!-- PaylaÅŸ Butonu -->
                        <Button Text="PaylaÅŸ"
                                Command="{Binding CreateServiceCommand}"
                                IsEnabled="{Binding IsPosting, Converter={StaticResource InverseBoolConverter}}"
                                BackgroundColor="#4CAF50"
                                TextColor="White"
                                FontAttributes="Bold"
                                FontSize="16"
                                CornerRadius="12"
                                HeightRequest="50"
                                Margin="0,10,0,0">
                            <Button.Shadow>
                                <Shadow Brush="#4CAF50" Offset="0,4" Radius="8" Opacity="0.3"/>
                            </Button.Shadow>
                        </Button>
                    </VerticalStackLayout>
                </ScrollView>
            </Border>
        </Grid>

    </Grid>

</ContentPage>
