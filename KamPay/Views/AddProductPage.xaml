<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:conv="clr-namespace:KamPay.Converters"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             x:Class="KamPay.Views.AddProductPage"
             x:DataType="vm:AddProductViewModel"
             Title="ÃœrÃ¼n Ekle"
             Shell.BackgroundColor="#4CAF50">

    <!-- ðŸ”¥ Ana Grid: ScrollView + Loading Overlay -->
    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="15">

                <!-- Hata MesajÄ± -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"
                       BackgroundColor="#FFEBEE"
                       BorderColor="#F44336"
                       Padding="10"
                       CornerRadius="8">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="#C62828"
                           FontSize="14" />
                </Frame>

                <!-- ðŸ”¥ Upload Progress -->
                <Frame IsVisible="{Binding IsLoading}"
                       BackgroundColor="#E3F2FD"
                       BorderColor="#2196F3"
                       Padding="15"
                       CornerRadius="8">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="{Binding UploadProgress}"
                               TextColor="#1976D2"
                               FontSize="14"
                               FontAttributes="Bold" />
                        <ProgressBar Progress="{Binding UploadPercentage}"
                                     ProgressColor="#2196F3"
                                     HeightRequest="8" />
                        <Label Text="{Binding UploadPercentage, StringFormat='{0:P0}'}"
                               TextColor="#1976D2"
                               FontSize="12"
                               HorizontalTextAlignment="End" />
                    </VerticalStackLayout>
                </Frame>

                <!-- BaÅŸlÄ±k -->
                <Label Text="ÃœrÃ¼n Bilgileri" 
                       FontSize="20" 
                       FontAttributes="Bold"
                       TextColor="#333" />

                <!-- ÃœrÃ¼n BaÅŸlÄ±ÄŸÄ± -->
                <Frame Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Entry Placeholder="ÃœrÃ¼n BaÅŸlÄ±ÄŸÄ± *"
                           Text="{Binding Title}"
                           MaxLength="100"
                           FontSize="16" />
                </Frame>

                <!-- AÃ§Ä±klama -->
                <Frame Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Editor Placeholder="ÃœrÃ¼n AÃ§Ä±klamasÄ± *"
                            Text="{Binding Description}"
                            HeightRequest="120"
                            MaxLength="1000"
                            FontSize="16"
                            AutoSize="TextChanges" />
                </Frame>

                <!-- Kategori SeÃ§imi -->
                <Label Text="Kategori *" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="#666" />

                <Frame Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Picker ItemsSource="{Binding Categories}"
                            SelectedItem="{Binding SelectedCategory}"
                            ItemDisplayBinding="{Binding Name}"
                            FontSize="16"
                            Title="Kategori SeÃ§in" />
                </Frame>

                <!-- ÃœrÃ¼n Tipi -->
                <Label Text="ÃœrÃ¼n Tipi *" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="#666" />

                <Frame Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Picker ItemsSource="{Binding ProductTypes}"
                            SelectedItem="{Binding SelectedType}"
                            FontSize="16"
                            Title="Tip SeÃ§in" />
                </Frame>

                <!-- SÃ¼rpriz Kutu Switch -->
                <StackLayout Orientation="Horizontal" 
                             Padding="5,10" 
                             IsVisible="{Binding IsDonationTypeSelected}">
                    <Label Text="Bu Ã¼rÃ¼nÃ¼ SÃ¼rpriz Kutu'ya baÄŸÄ±ÅŸla" 
                           VerticalOptions="Center"
                           TextColor="#333"/>
                    <Switch IsToggled="{Binding IsForSurpriseBox}" 
                            HorizontalOptions="EndAndExpand"
                            OnColor="#4CAF50"/>
                </StackLayout>

                <!-- Fiyat (SatÄ±ÅŸ ise) -->
                <Frame IsVisible="{Binding ShowPriceField}"
                       Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <HorizontalStackLayout Padding="10">
                        <Entry Placeholder="Fiyat"
                               Text="{Binding Price}"
                               Keyboard="Numeric"
                               FontSize="16"
                               HorizontalOptions="FillAndExpand" />
                        <Label Text="â‚º" 
                               VerticalOptions="Center"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="#4CAF50" />
                    </HorizontalStackLayout>
                </Frame>

                <!-- Takas Tercihi (Takas ise) -->
                <Frame IsVisible="{Binding ShowExchangeField}"
                       Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Entry Placeholder="Ne ile takas yapmak istersiniz?"
                           Text="{Binding ExchangePreference}"
                           FontSize="16" />
                </Frame>

                <!-- Durum -->
                <Label Text="ÃœrÃ¼n Durumu *" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="#666" />

                <Frame Padding="0" 
                       BorderColor="#E0E0E0"
                       CornerRadius="8">
                    <Picker ItemsSource="{Binding Conditions}"
                            SelectedItem="{Binding SelectedCondition}"
                            FontSize="16"
                            Title="Durum SeÃ§in">
                        <Picker.ItemDisplayBinding>
                            <Binding>
                                <Binding.Converter>
                                    <conv:ProductConditionConverter />
                                </Binding.Converter>
                            </Binding>
                        </Picker.ItemDisplayBinding>
                    </Picker>
                </Frame>

                <!-- Konum -->
                <Label Text="Konum *"
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="#666" />

                <!-- EtkileÅŸimli Harita -->
                <Border StrokeShape="RoundRectangle 12" 
                        StrokeThickness="0"
                        HeightRequest="250"
                        Margin="0,8,0,0">
                    <Grid>
                        <mapsui:MapControl x:Name="ProductMap"
                                           VerticalOptions="FillAndExpand"
                                           HorizontalOptions="FillAndExpand" />
                        
                        <!-- Zoom and Navigation Controls -->
                        <VerticalStackLayout HorizontalOptions="End" 
                                            VerticalOptions="Start"
                                            Margin="12"
                                            Spacing="8">
                            
                            <!-- Zoom In Button -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="White"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0">
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                                </Border.Shadow>
                                <Button Text="+"
                                        Clicked="OnZoomInClicked"
                                        FontSize="22"
                                        FontAttributes="Bold"
                                        BackgroundColor="Transparent"
                                        TextColor="#333"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Padding="0"/>
                            </Border>
                            
                            <!-- Zoom Out Button -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="White"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0">
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                                </Border.Shadow>
                                <Button Text="âˆ’"
                                        Clicked="OnZoomOutClicked"
                                        FontSize="22"
                                        FontAttributes="Bold"
                                        BackgroundColor="Transparent"
                                        TextColor="#333"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Padding="0"/>
                            </Border>
                            
                            <!-- Separator -->
                            <BoxView HeightRequest="1" 
                                     WidthRequest="30"
                                     BackgroundColor="#E0E0E0"
                                     HorizontalOptions="Center"
                                     Margin="0,4"/>
                            
                            <!-- My Location Button -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="White"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0">
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                                </Border.Shadow>
                                <Button Text="ðŸ“"
                                        Command="{Binding UseCurrentLocationCommand}"
                                        FontSize="18"
                                        BackgroundColor="Transparent"
                                        TextColor="#4CAF50"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Padding="0"/>
                            </Border>
                            
                            <!-- Reset/Center Button -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="White"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    Padding="0">
                                <Border.Shadow>
                                    <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                                </Border.Shadow>
                                <Button Text="ðŸŽ¯"
                                        Clicked="OnResetLocationClicked"
                                        FontSize="18"
                                        BackgroundColor="Transparent"
                                        TextColor="#2196F3"
                                        WidthRequest="40"
                                        HeightRequest="40"
                                        Padding="0"/>
                            </Border>
                        </VerticalStackLayout>
                        
                        <!-- SeÃ§ili konum bilgisi -->
                        <Border StrokeShape="RoundRectangle 12"
                                BackgroundColor="#F5F5F5"
                                Padding="12,8"
                                Margin="12"
                                VerticalOptions="End"
                                HorizontalOptions="FillAndExpand"
                                IsVisible="{Binding HasLocation}">
                            <Border.Shadow>
                                <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2"/>
                            </Border.Shadow>
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="ðŸ“Œ" 
                                       FontSize="16"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding Location}"
                                       FontSize="12"
                                       TextColor="#333"
                                       VerticalOptions="Center"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"
                                       HorizontalOptions="FillAndExpand"/>
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Border>

                <!-- Konum bilgi metni -->
                <Label Text="Harita Ã¼zerine tÄ±klayarak konumunuzu seÃ§in veya ðŸ“ butonuna basarak mevcut konumunuzu kullanÄ±n"
                       FontSize="12"
                       TextColor="{StaticResource Gray600}"
                       Margin="0,4,0,0"/>

                <!-- GÃ¶rseller -->
                <Label Text="ÃœrÃ¼n GÃ¶rselleri (Maksimum 5) *" 
                       FontSize="16" 
                       FontAttributes="Bold"
                       TextColor="#666" />

                <Button Text="ðŸ“· GÃ¶rsel Ekle"
                        Command="{Binding PickImagesCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        CornerRadius="8"
                        HeightRequest="50" />

                <!-- SeÃ§ili GÃ¶rseller -->
                <FlexLayout BindableLayout.ItemsSource="{Binding ImagePaths}"
                            Wrap="Wrap"
                            JustifyContent="Start"
                            AlignItems="Start">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="5"
                                   Margin="5"
                                   CornerRadius="8"
                                   WidthRequest="100"
                                   HeightRequest="100">
                                <Grid>
                                    <Image Source="{Binding .}"
                                           Aspect="AspectFill" />
                                    <Button Text="âœ•"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AddProductViewModel}}, Path=RemoveImageCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="#F44336"
                                            TextColor="White"
                                            WidthRequest="30"
                                            HeightRequest="30"
                                            CornerRadius="15"
                                            HorizontalOptions="End"
                                            VerticalOptions="Start"
                                            Margin="5" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>

                <!-- Butonlar -->
                <Grid ColumnDefinitions="*,*" 
                      ColumnSpacing="10"
                      Margin="0,20,0,0">
                    <Button Grid.Column="0"
                            Text="Ä°ptal"
                            Command="{Binding CancelCommand}"
                            BackgroundColor="#757575"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="50" />

                    <Button Grid.Column="1"
                            Text="Kaydet"
                            Command="{Binding SaveProductCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="50" />
                </Grid>

            </VerticalStackLayout>
        </ScrollView>

        <!-- ðŸ”¥ Loading Overlay - En Ã¼stte, tam ekran -->
        <Grid IsVisible="{Binding IsLoading}"
              BackgroundColor="#80000000"
              InputTransparent="False">
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="15">
                <ActivityIndicator IsRunning="True"
                                   Color="White"
                                   WidthRequest="50"
                                   HeightRequest="50" />
                <Label Text="{Binding UploadProgress}"
                       TextColor="White"
                       FontSize="16"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center"
                       IsVisible="{Binding UploadProgress, Converter={StaticResource StringIsNotNullOrEmptyConverter}}" />
            </VerticalStackLayout>
        </Grid>
    </Grid>

</ContentPage>