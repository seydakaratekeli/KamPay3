<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             xmlns:models="clr-namespace:KamPay.Models"
             xmlns:converters="clr-namespace:KamPay.Converters"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
             x:Class="KamPay.Views.MessagesPage"
             x:DataType="vm:MessagesViewModel"
             Title="Mesajlar"
             BackgroundColor="White">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
            <converters:IsPendingConverter x:Key="IsPendingConverter"/>
            <converters:IsNotZeroConverter x:Key="IsNotZeroConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- ARAMA Ã‡UBUÄžU -->
        <Grid Grid.Row="0" Padding="15,10">
            <Border StrokeShape="RoundRectangle 10" 
                    StrokeThickness="1"
                    Stroke="{StaticResource Gray300}"
                    BackgroundColor="{StaticResource Gray100}"
                    HeightRequest="45"
                    Padding="10,0">
                <Grid ColumnDefinitions="Auto,*">
                    <Image Source="search_icon.svg" 
                           HeightRequest="20" 
                           WidthRequest="20" 
                           VerticalOptions="Center" 
                           Opacity="0.5"/>
                    <Entry Grid.Column="1" 
                           Placeholder="Sohbetlerde ara..." 
                           TextColor="{StaticResource Gray900}"
                           PlaceholderColor="{StaticResource Gray500}"
                           VerticalOptions="Center"
                           Margin="10,0,0,0"/>
                </Grid>
            </Border>
        </Grid>

        <!-- ANA Ä°Ã‡ERÄ°K GRID -->
        <Grid Grid.Row="1">

            <!-- REFRESH VIEW -->
            <RefreshView Command="{Binding RefreshConversationsCommand}"
                         IsRefreshing="{Binding IsRefreshing}"
                         RefreshColor="{StaticResource Primary}"
                         IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">

                <CollectionView ItemsSource="{Binding Conversations}"
                                SelectionMode="Single"
                                SelectedItem="{Binding SelectedConversation}"
                                SelectionChangedCommand="{Binding ConversationTappedCommand}"
                                SelectionChangedCommandParameter="{Binding SelectedConversation}">

                    <!-- EMPTY VIEW -->
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" 
                                             HorizontalOptions="Center" 
                                             Spacing="15" 
                                             Padding="30">
                            <Label Text="ðŸ’¬" 
                                   FontSize="60" 
                                   HorizontalTextAlignment="Center" 
                                   Opacity="0.3"/>
                            <Label Text="HenÃ¼z mesajÄ±nÄ±z yok." 
                                   TextColor="{StaticResource Gray500}"
                                   FontSize="16"
                                   HorizontalTextAlignment="Center"/>
                            <Label Text="Bir Ã¼rÃ¼n Ã¼zerinden mesajlaÅŸmaya baÅŸlayabilirsiniz." 
                                   TextColor="{StaticResource Gray400}"
                                   FontSize="13"
                                   HorizontalTextAlignment="Center"
                                   Margin="0,5,0,0"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <!-- ITEM TEMPLATE -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Conversation">

                            <Grid Padding="15,10" 
                                  ColumnDefinitions="Auto,*,Auto" 
                                  ColumnSpacing="15" 
                                  BackgroundColor="White">

                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MessagesViewModel}}, Path=ConversationTappedCommand}"
                                        CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>

                                <!-- PROFÄ°L FOTO -->
                                <Grid Grid.Column="0" HeightRequest="55" WidthRequest="55">
                                    <ffimageloading:CachedImage 
                                        Source="{Binding OtherUserPhotoUrl}" 
                                        Aspect="AspectFill"
                                        HeightRequest="55" 
                                        WidthRequest="55"
                                        LoadingPlaceholder="default_avatar.png"
                                        ErrorPlaceholder="default_avatar.png"
                                        DownsampleToViewSize="True"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Center">
                                        <ffimageloading:CachedImage.Clip>
                                            <EllipseGeometry Center="27.5,27.5" RadiusX="27.5" RadiusY="27.5"/>
                                        </ffimageloading:CachedImage.Clip>
                                    </ffimageloading:CachedImage>
                                </Grid>

                                <!-- KULLANICI BÄ°LGÄ°SÄ° -->
                                <VerticalStackLayout Grid.Column="1" 
                                                     VerticalOptions="Center" 
                                                     Spacing="2">
                                    <Label Text="{Binding OtherUserName}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="{StaticResource Gray900}"
                                           LineBreakMode="TailTruncation"/>

                                    <Label Text="{Binding LastMessage}" 
                                           FontSize="14" 
                                           TextColor="{StaticResource Gray500}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1"/>
                                </VerticalStackLayout>

                                <!-- ZAMAN â€“ BADGE -->
                                <VerticalStackLayout Grid.Column="2" 
                                                     VerticalOptions="Center" 
                                                     HorizontalOptions="End" 
                                                     Spacing="5">

                                    <Label Text="{Binding LastMessageTimeText}" 
                                           FontSize="12" 
                                           TextColor="{StaticResource Gray500}"
                                           HorizontalOptions="End"/>

                                    <Border BackgroundColor="{StaticResource Primary}" 
                                            StrokeThickness="0"
                                            HeightRequest="22" 
                                            WidthRequest="22" 
                                            StrokeShape="RoundRectangle 11"
                                            HorizontalOptions="End"
                                            IsVisible="{Binding UnreadCount, Converter={StaticResource IsNotZeroConverter}}">
                                        <Label Text="{Binding UnreadCount}" 
                                               TextColor="White" 
                                               FontSize="11" 
                                               FontAttributes="Bold"
                                               HorizontalOptions="Center" 
                                               VerticalOptions="Center"/>
                                    </Border>

                                </VerticalStackLayout>

                                <!-- ALT Ã‡Ä°ZGÄ° -->
                                <BoxView Grid.ColumnSpan="3"
                                         HeightRequest="1"
                                         Color="{StaticResource Gray200}"
                                         VerticalOptions="End"
                                         Margin="60,0,0,0"/>
                            </Grid>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>

            <!-- LOADING EKRANI -->
            <Grid IsVisible="{Binding IsLoading}" BackgroundColor="White">
                <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="15">
                    <ActivityIndicator IsRunning="True" 
                                       Color="{StaticResource Primary}"
                                       WidthRequest="50" 
                                       HeightRequest="50"/>
                    <Label Text="Mesajlar yÃ¼kleniyor..." 
                           TextColor="{StaticResource Gray600}"
                           FontSize="14"
                           HorizontalTextAlignment="Center"/>
                </VerticalStackLayout>
            </Grid>

        </Grid>
    </Grid>
</ContentPage>
